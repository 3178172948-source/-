<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê≠§ÂàªÂú∞Âõæ - MomentMap</title>
    <style>
        /* ==================== ÂÖ®Â±ÄÊ†∑Âºè ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #021024;
            touch-action: pan-x pan-y;
        }

        /* ==================== ÁôªÂΩïÁïåÈù¢ ==================== */
        .login-box {
            background: white;
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .login-box h1 {
            text-align: center;
            color: #021024;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .login-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #c1e8ff;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .verify-code-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .verify-code-row input {
            flex: 1;
            margin-bottom: 0;
        }

        .verify-code-row button {
            padding: 12px 15px;
            background: #5483B3;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            min-width: 90px;
        }

        .verify-code-row button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
        }

        /* ==================== Âú®Á∫ø‰∫∫Êï∞ÊòæÁ§∫ ==================== */
        .online-badge {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 1000;
            font-size: 13px;
            color: #052659;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .online-count {
            color: #32CD32;
            font-weight: bold;
        }

        /* ==================== ‰∏ªÁïåÈù¢ ==================== */
        #mainScreen {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .profile-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: white;
            border: 3px solid #5483B3;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .local-area-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 22px;
        }

        /* ==================== ‰∏™‰∫∫ÁïåÈù¢ ==================== */
        #profileScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #c1e8ff 0%, #7da0ca 100%);
            z-index: 9000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #profileScreen.has-background {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .back-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .profile-header {
            padding: 70px 20px 25px;
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 4px solid #5483B3;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            color: #021024;
        }

        .profile-nickname {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 13px;
            color: #052659;
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .profile-action-btn {
            padding: 8px 25px;
            background: white;
            border: 2px solid #5483B3;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            color: #052659;
        }

        .profile-tabs {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 12px 0;
            border-radius: 20px 20px 0 0;
            margin: 0 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .profile-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #052659;
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 14px;
        }

        .profile-tab.active {
            border-bottom-color: #5483B3;
            color: #5483B3;
            font-weight: bold;
        }

        .profile-content {
            background: white;
            min-height: 300px;
            padding: 15px;
            margin: 0 10px 20px;
            border-radius: 10px;
        }

        .profile-search {
            padding: 10px 15px;
            background: white;
            margin: 0 10px 10px;
            border-radius: 10px;
            display: none;
        }

        .profile-search.active {
            display: block;
        }

        .profile-search input {
            width: 100%;
            padding: 10px;
            border: 2px solid #c1e8ff;
            border-radius: 8px;
            font-size: 14px;
        }

        .post-item {
            padding: 12px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            border-left: 3px solid #5483B3;
        }

        .post-item:hover {
            background: #e9ecef;
        }

        .post-item-title {
            font-weight: bold;
            color: #021024;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .post-item-content {
            color: #7da0ca;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .post-item-time {
            color: #999;
            font-size: 11px;
        }

        .top-right-btns {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ==================== Â±ÄÂüüÁïåÈù¢ ==================== */
        #localScreen {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
        }

        #localMap {
            width: 100%;
            height: 100%;
        }

        .local-back-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: white;
            border: 2px solid #5483B3;
            cursor: pointer;
            z-index: 1000;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .local-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .local-action-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            color: white;
        }

        .publish-btn {
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
        }

        .discover-btn {
            background: linear-gradient(135deg, #7da0ca 0%, #5483B3 100%);
        }

        /* ==================== üîß Ê∞îÊ≥°Ê†∑ÂºèÔºàÁßªÈô§ËìùËâ≤Ê†áÂøóÔºâ==================== */
        .bubble {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: bubble-pulse 2s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
        }

        @keyframes bubble-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .bubble-recommend { background: #FF4444; }
        .bubble-help { background: #FFD700; }
        .bubble-team { background: #4169E1; }
        .bubble-warning { background: #9932CC; }
        .bubble-group { background: #32CD32; }
        .bubble-news { background: #FF69B4; }

        /* üîß Áî®Êà∑ÈÄâÂÆö‰ΩçÁΩÆÁöÑÂÆö‰ΩçÊ†áÂøó */
        .location-marker {
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* ==================== Ê∞îÊ≥°ÊëòË¶ÅÂç°Áâá ==================== */
        .bubble-preview-card {
            position: fixed;
            bottom: 90px;
            left: 5%;
            right: 5%;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            max-width: 400px;
            margin: 0 auto;
        }

        .bubble-preview-card .close-preview {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            z-index: 10;
        }

        .bubble-preview-card.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .preview-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #5483B3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .preview-title {
            font-weight: bold;
            color: #021024;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .preview-content {
            color: #052659;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
            max-height: 60px;
            overflow: hidden;
        }

        .preview-detail-btn {
            width: 100%;
            padding: 10px;
            background: #5483B3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ==================== Áæ§ËÅäÈ¢ÑËßàÂç°Áâá ==================== */
        .group-preview-card {
            position: fixed;
            bottom: 90px;
            left: 5%;
            right: 5%;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            max-width: 400px;
            margin: 0 auto;
        }

        .group-preview-card .close-preview {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            z-index: 10;
        }

        .group-preview-card.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .group-info {
            margin-bottom: 15px;
        }

        .group-name {
            font-weight: bold;
            color: #021024;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .group-online {
            color: #7da0ca;
            font-size: 12px;
        }

        .join-group-btn {
            width: 100%;
            padding: 10px;
            background: #5483B3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ==================== ÂºπÁ™óÈÄöÁî®Ê†∑Âºè ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            margin: 20px auto;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            left: 12px;
            background: #f0f0f0;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        /* ==================== ÂÆö‰ΩçÈÄâÊã©ÁïåÈù¢ ==================== */
        .location-select {
            padding: 15px 0;
        }

        .location-select h2 {
            color: #021024;
            margin-bottom: 18px;
            font-size: 20px;
        }

        .location-select h3 {
            color: #052659;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .location-select input {
            width: 100%;
            padding: 12px;
            border: 2px solid #c1e8ff;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 12px;
        }

        .location-suggestions {
            max-height: 180px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .suggestion-item {
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            border-left: 3px solid #5483B3;
            font-size: 14px;
        }

        .suggestion-item:hover {
            background: #e9ecef;
        }

        .range-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .range-option {
            padding: 12px;
            border: 2px solid #5483B3;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            background: white;
            color: #052659;
            font-size: 14px;
        }

        .range-option.selected {
            background: #5483B3;
            color: white;
        }

        .confirm-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #5483B3 0%, #052659 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            cursor: pointer;
            margin-top: 18px;
        }

        /* ==================== ÂèëÂ∏ÉÁïåÈù¢ ==================== */
        .publish-screen h2 {
            color: #021024;
            margin-bottom: 18px;
            font-size: 20px;
        }

        .tag-group {
            margin-bottom: 18px;
        }

        .tag-group h3 {
            color: #052659;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 7px 14px;
            border: 2px solid #7da0ca;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            background: white;
            color: #052659;
        }

        .tag.selected {
            background: #5483B3;
            color: white;
            border-color: #5483B3;
        }

        .publish-screen textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #c1e8ff;
            border-radius: 10px;
            font-size: 15px;
            min-height: 120px;
            margin-top: 12px;
            resize: vertical;
        }

        .publish-screen input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #c1e8ff;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 12px;
        }

        .duration-select {
            margin-top: 12px;
        }

        .duration-select select {
            width: 100%;
            padding: 12px;
            border: 2px solid #c1e8ff;
            border-radius: 10px;
            font-size: 15px;
        }

        .privacy-toggle {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #052659;
            font-size: 14px;
        }

        /* ==================== ‰ΩçÁΩÆÈÄâÊã©ÔºàÊñ∞Â¢ûÔºâ ==================== */
        .location-input-group {
            margin-top: 15px;
        }

        .location-method {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .location-method button {
            flex: 1;
            padding: 10px;
            border: 2px solid #5483B3;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #052659;
        }

        .location-method button.active {
            background: #5483B3;
            color: white;
        }

        /* ==================== Â∏ñÂ≠êËØ¶ÊÉÖ ==================== */
        .post-detail {
            padding: 15px 0;
        }

        .post-detail h2 {
            color: #021024;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .post-content {
            color: #052659;
            line-height: 1.6;
            margin: 12px 0;
            font-size: 14px;
        }

        .post-actions {
            display: flex;
            gap: 10px;
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid #c1e8ff;
            flex-wrap: wrap;
        }

        .post-action-btn {
            padding: 8px 15px;
            border: 2px solid #5483B3;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            color: #052659;
        }

        /* ==================== ËØÑËÆ∫Âå∫ ==================== */
        .comments-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #c1e8ff;
        }

        .comments-section h3 {
            color: #021024;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .comment-item {
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 8px;
        }

        .comment-author {
            font-weight: bold;
            color: #5483B3;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .comment-content {
            color: #052659;
            font-size: 13px;
            line-height: 1.4;
        }

        .comment-time {
            color: #999;
            font-size: 11px;
            margin-top: 5px;
        }

        /* ==================== Áä∂ÊÄÅÈÄâÊã©ÂºπÁ™ó ==================== */
        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 18px;
        }

        .status-option {
            padding: 18px;
            border: 2px solid #7da0ca;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            background: white;
            color: #052659;
        }

        .status-option.selected {
            background: #5483B3;
            color: white;
            border-color: #5483B3;
        }

        /* ==================== ËÅäÂ§©ÂÆ§ ==================== */
        .chatroom {
            display: flex;
            flex-direction: column;
            height: 450px;
        }

        .chatroom-header {
            padding: 12px;
            background: #5483B3;
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatroom-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
        }

        .chat-message {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chat-message .nickname {
            font-weight: bold;
            color: #5483B3;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .chat-message .content {
            color: #052659;
            font-size: 14px;
        }

        .chat-forward {
            padding: 8px;
            background: #e3f2fd;
            border-left: 3px solid #5483B3;
            margin-top: 5px;
            border-radius: 5px;
        }

        .chat-forward-title {
            font-weight: bold;
            font-size: 12px;
            color: #5483B3;
            margin-bottom: 3px;
        }

        .chat-forward-content {
            font-size: 11px;
            color: #666;
        }

        .chatroom-input {
            display: flex;
            padding: 12px;
            background: white;
            border-radius: 0 0 15px 15px;
            border-top: 1px solid #c1e8ff;
            gap: 8px;
        }

        .chatroom-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #c1e8ff;
            border-radius: 10px;
            font-size: 14px;
        }

        .chatroom-input button {
            padding: 10px 18px;
            background: #5483B3;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ==================== VIP ==================== */
        .vip-benefits {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 18px;
        }

        .vip-benefit {
            padding: 18px;
            background: linear-gradient(135deg, #c1e8ff 0%, #7da0ca 100%);
            border-radius: 15px;
            text-align: center;
            color: #021024;
        }

        .vip-benefit h4 {
            margin-bottom: 8px;
            font-size: 15px;
        }

        .vip-benefit p {
            font-size: 12px;
        }

        /* ==================== Êî∂‰ª∂ÁÆ± ==================== */
        .inbox-tabs {
            display: flex;
            border-bottom: 2px solid #c1e8ff;
            margin-bottom: 18px;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .inbox-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            color: #052659;
            font-size: 14px;
            min-width: 80px;
        }

        .inbox-tab.active {
            border-bottom-color: #5483B3;
            color: #5483B3;
            font-weight: bold;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
        }

        .friend-item:hover {
            background: #e9ecef;
        }

        .friend-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #5483B3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: bold;
            color: #021024;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .friend-status {
            color: #7da0ca;
            font-size: 12px;
        }

        .friend-selector {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .friend-selector-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
        }

        .friend-selector-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .settings-list {
            padding: 10px 0;
        }

        .settings-item {
            padding: 13px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .settings-item:hover {
            background: #e9ecef;
        }

        .notification-item {
            padding: 12px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 10px;
            border-left: 3px solid #5483B3;
        }

        .notification-item.unread {
            background: #e3f2fd;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .notification-type {
            font-weight: bold;
            color: #5483B3;
            font-size: 13px;
        }

        .notification-time {
            color: #999;
            font-size: 11px;
        }

        .notification-content {
            color: #052659;
            font-size: 13px;
        }

        /* ==================== ÂìçÂ∫îÂºèËÆæËÆ° ==================== */
        @media (max-width: 768px) {
            .login-box {
                width: 85%;
                padding: 25px 18px;
            }

            .login-box h1 {
                font-size: 22px;
            }

            .range-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .status-options {
                grid-template-columns: 1fr;
            }

            .vip-benefits {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px 15px;
            }

            .profile-header {
                padding: 65px 15px 20px;
            }

            .profile-avatar {
                width: 70px;
                height: 70px;
                font-size: 35px;
            }

            .profile-nickname {
                font-size: 20px;
            }

            .profile-tabs {
                font-size: 13px;
            }

            .tag {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        @media (max-width: 480px) {
            .online-badge {
                font-size: 12px;
                padding: 5px 10px;
            }

            .profile-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .local-area-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 70px;
            }

            .bubble {
                width: 32px;
                height: 32px;
                font-size: 10px;
            }

            .chatroom {
                height: 400px;
            }
        }

        /* ==================== ÁΩëÁªúÁä∂ÊÄÅÊèêÁ§∫ ==================== */
        .network-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-size: 14px;
            display: none;
        }

        .network-status.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

    <div class="network-status" id="networkStatus">Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...</div>

    <div class="online-badge" id="onlineBadge" style="display: none;">
        Âú®Á∫ø: <span class="online-count" id="onlineCount">0</span>
    </div>

    <!-- ==================== ÁôªÂΩïÁïåÈù¢ ==================== -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>üó∫Ô∏è Ê≠§ÂàªÂú∞Âõæ</h1>
            <input type="tel" id="phoneInput" placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑" maxlength="11">
            <div class="verify-code-row">
                <input type="text" id="codeInput" placeholder="È™åËØÅÁ†Å" maxlength="6">
                <button id="getCodeBtn">Ëé∑ÂèñÈ™åËØÅÁ†Å</button>
            </div>
            <button class="login-btn" id="loginBtn">ÁôªÂΩï</button>
        </div>
    </div>

    <!-- ==================== ‰∏ªÁïåÈù¢ ==================== -->
    <div id="mainScreen">
        <div id="map"></div>
        <div class="profile-btn" id="profileBtn">üë§</div>
        <button class="local-area-btn" id="localAreaBtn">üìç</button>
    </div>

    <!-- ==================== ‰∏™‰∫∫ÁïåÈù¢ ==================== -->
    <div id="profileScreen">
        <button class="back-btn" id="profileBackBtn">‚Üê ËøîÂõû</button>
        <div class="top-right-btns">
            <button class="icon-btn" id="inboxBtn">üì¨</button>
            <button class="icon-btn" id="settingsBtn">‚öôÔ∏è</button>
        </div>

        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">üë§</div>
            <div class="profile-info">
                <div class="profile-nickname" id="profileNickname">Áî®Êà∑ÊòµÁß∞</div>
                <div class="profile-id" id="profileId">ID: 123456</div>
            </div>
        </div>

        <div class="profile-actions">
            <button class="profile-action-btn" id="statusBtn">Áä∂ÊÄÅ</button>
            <button class="profile-action-btn" id="vipBtn">‰ºöÂëò‰∏≠ÂøÉ</button>
        </div>

        <div class="profile-tabs">
            <div class="profile-tab active" data-tab="posts">ÊàëÂèëÂ∏ÉÁöÑ</div>
            <div class="profile-tab" data-tab="likes">ÁÇπËµû</div>
            <div class="profile-tab" data-tab="favorites">Êî∂Ëóè</div>
            <div class="profile-tab" data-tab="comments">ËØÑËÆ∫</div>
            <div class="profile-tab" data-tab="history">ÊµèËßàËÆ∞ÂΩï</div>
            <div class="profile-tab" data-tab="search">ÊêúÁ¥¢</div>
        </div>

        <div class="profile-search" id="profileSearch">
            <input type="text" id="profileSearchInput" placeholder="ÊêúÁ¥¢Â∏ñÂ≠êÂÖ≥ÈîÆËØç...">
        </div>

        <div class="profile-content" id="profileContent">
            <p style="color: #7da0ca; text-align: center; padding: 40px 0;">ÊöÇÊó†ÂÜÖÂÆπ</p>
        </div>
    </div>

    <!-- ==================== Â±ÄÂüüÁïåÈù¢ ==================== -->
    <div id="localScreen">
        <div id="localMap"></div>
        <div class="profile-btn" id="localProfileBtn">üë§</div>
        <button class="local-back-btn" id="localBackBtn">‚Üê</button>
        <div class="local-actions">
            <button class="local-action-btn publish-btn" id="publishBtn">ÂèëÂ∏É</button>
            <button class="local-action-btn discover-btn" id="discoverBtn">ÂèëÁé∞</button>
        </div>
    </div>

    <!-- ==================== Ê∞îÊ≥°ÊëòË¶ÅÂç°Áâá ==================== -->
    <div class="bubble-preview-card" id="bubblePreviewCard">
        <button class="close-preview" onclick="closeBubblePreview()">√ó</button>
        <div class="preview-header">
            <div class="preview-avatar" id="previewAvatar" onclick="visitUserProfile()">üë§</div>
            <div>
                <div id="previewNickname" style="color: #021024; font-weight: bold; font-size: 13px;"></div>
                <div id="previewTime" style="color: #7da0ca; font-size: 11px;"></div>
            </div>
        </div>
        <div id="previewTitle" class="preview-title"></div>
        <div id="previewContent" class="preview-content"></div>
        <button class="preview-detail-btn" id="viewDetailBtn">Êü•ÁúãËØ¶ÊÉÖ</button>
    </div>

    <!-- ==================== Áæ§ËÅäÈ¢ÑËßàÂç°Áâá ==================== -->
    <div class="group-preview-card" id="groupPreviewCard">
        <button class="close-preview" onclick="closeGroupPreview()">√ó</button>
        <div class="group-info">
            <div class="group-name" id="groupPreviewName"></div>
            <div class="group-online" id="groupPreviewOnline"></div>
        </div>
        <button class="join-group-btn" id="joinGroupBtn">Âä†ÂÖ•ËÅäÂ§©ÂÆ§</button>
    </div>

    <!-- ==================== ÂÆö‰ΩçÈÄâÊã©ÂºπÁ™ó ==================== -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('locationModal')">√ó</button>
            <div class="location-select">
                <h2>ÈÄâÊã©‰ΩçÁΩÆ</h2>
                <input type="text" id="locationInput" placeholder="ÊêúÁ¥¢Âú∞ÁÇπÊàñÊ¥ªÂä®ÔºàÂ¶ÇÔºöÂ§©ÂÆâÈó®Ôºâ">
                <div id="locationSuggestions" class="location-suggestions"></div>
                <h3>ÈÄâÊã©ËåÉÂõ¥</h3>
                <div class="range-options">
                    <div class="range-option" data-range="100">100Á±≥</div>
                    <div class="range-option" data-range="500">500Á±≥</div>
                    <div class="range-option selected" data-range="1000">1ÂçÉÁ±≥</div>
                    <div class="range-option" data-range="2000">2ÂçÉÁ±≥</div>
                    <div class="range-option" data-range="3000">3ÂçÉÁ±≥</div>
                    <div class="range-option" data-range="4000">4ÂçÉÁ±≥</div>
                </div>
                <button class="confirm-btn" id="confirmLocationBtn">Á°ÆËÆ§ËøõÂÖ•</button>
            </div>
        </div>
    </div>

    <!-- ==================== Á≠õÈÄâÂºπÁ™ó ==================== -->
    <div id="filterModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('filterModal')">√ó</button>
            <div class="location-select">
                <h2>Á≠õÈÄâÊ∞îÊ≥°</h2>
                
                <div class="tag-group">
                    <h3>Ê¥ªÂä®Á±ªÂûãÔºàÂèØÂ§öÈÄâÔºâ</h3>
                    <div class="tags" id="filterActivityTags">
                        <div class="tag" data-tag="nature">Ëá™ÁÑ∂È£éÊôØ</div>
                        <div class="tag" data-tag="exhibition">Â±ïËßàÊºîÂá∫</div>
                        <div class="tag" data-tag="sports">‰ΩìËÇ≤Ê¥ªÂä®</div>
                        <div class="tag" data-tag="food">Â•ΩÂêÉÂ•ΩÂñù</div>
                        <div class="tag" data-tag="culture">‰∫∫ÊñáÂéÜÂè≤</div>
                        <div class="tag" data-tag="other">ÂÖ∂‰ªñ</div>
                    </div>
                </div>

                <div class="tag-group">
                    <h3>Ê∞îÊ≥°Á±ªÂûãÔºàÂèØÂ§öÈÄâÔºâ</h3>
                    <div class="tags" id="filterBubbleTags">
                        <div class="tag" data-tag="recommend">Êé®Ëçê</div>
                        <div class="tag" data-tag="help">Ê±ÇÂä©</div>
                        <div class="tag" data-tag="team">ÁªÑÈòü</div>
                        <div class="tag" data-tag="group">Âª∫Áæ§</div>
                        <div class="tag" data-tag="warning">ÈÅøÈõ∑</div>
                        <div class="tag" data-tag="news">ËßÅÈóª</div>
                    </div>
                </div>

                <button class="confirm-btn" id="confirmFilterBtn">Á°ÆËÆ§Á≠õÈÄâ</button>
                <button class="confirm-btn" id="clearFilterBtn" style="background: #7da0ca; margin-top: 10px;">Ê∏ÖÈô§Á≠õÈÄâ</button>
            </div>
        </div>
    </div>

    <!-- ==================== ÂèëÂ∏ÉÂºπÁ™ó ==================== -->
    <div id="publishModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('publishModal')">√ó</button>
            <div class="publish-screen">
                <h2>ÂèëÂ∏ÉÊ∞îÊ≥°</h2>

                <div class="tag-group">
                    <h3>Ê¥ªÂä®Á±ªÂûãÔºàÂèØÂ§öÈÄâÔºåÂèØ‰∏çÈÄâÔºâ</h3>
                    <div class="tags" id="publishActivityTags">
                        <div class="tag" data-tag="nature">Ëá™ÁÑ∂È£éÊôØ</div>
                        <div class="tag" data-tag="exhibition">Â±ïËßàÊºîÂá∫</div>
                        <div class="tag" data-tag="sports">‰ΩìËÇ≤Ê¥ªÂä®</div>
                        <div class="tag" data-tag="food">Â•ΩÂêÉÂ•ΩÂñù</div>
                        <div class="tag" data-tag="culture">‰∫∫ÊñáÂéÜÂè≤</div>
                        <div class="tag" data-tag="other">ÂÖ∂‰ªñ</div>
                    </div>
                </div>

                <div class="tag-group">
                    <h3>Ê∞îÊ≥°Á±ªÂûãÔºàÂøÖÈÄâÔºåÂè™ËÉΩÈÄâ‰∏Ä‰∏™Ôºâ</h3>
                    <div class="tags" id="publishBubbleTags">
                        <div class="tag" data-tag="recommend">Êé®Ëçê</div>
                        <div class="tag" data-tag="help">Ê±ÇÂä©</div>
                        <div class="tag" data-tag="team">ÁªÑÈòü</div>
                        <div class="tag" data-tag="group">Âª∫Áæ§</div>
                        <div class="tag" data-tag="warning">ÈÅøÈõ∑</div>
                        <div class="tag" data-tag="news">ËßÅÈóª</div>
                    </div>
                </div>

                <div id="normalPublishForm" style="display: none;">
                    <input type="text" id="postTitle" placeholder="Ê†áÈ¢òÔºàÂøÖÂ°´Ôºâ" required>
                    <textarea id="postContent" placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÊ≠§Âàª...ÔºàÈÄâÂ°´Ôºâ"></textarea>
                    
                    <!-- ‰ΩçÁΩÆÈÄâÊã© -->
                    <div class="location-input-group">
                        <h3 style="color: #052659; margin-bottom: 10px; font-size: 15px;">ÂèëÂ∏É‰ΩçÁΩÆ</h3>
                        <div class="location-method">
                            <button type="button" id="useCurrentLocationBtn" class="active">‰ΩøÁî®ÂΩìÂâç‰ΩçÁΩÆ</button>
                            <button type="button" id="useManualLocationBtn">ÊâãÂä®ËæìÂÖ•Âú∞ÂùÄ</button>
                        </div>
                        <input type="text" id="manualLocationInput" placeholder="ÊêúÁ¥¢Âú∞ÂùÄÔºàÂ¶ÇÔºöÂ§©ÂÆâÈó®Ôºâ" style="display: none;">
                        <div id="manualLocationSuggestions" class="location-suggestions" style="display: none;"></div>
                        <div id="selectedLocationDisplay" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #052659;">
                            üìç ÂΩìÂâç‰ΩçÁΩÆ
                        </div>
                    </div>

                    <div class="duration-select">
                        <label style="color: #052659;">Ê∞îÊ≥°ÊåÅÁª≠Êó∂Èó¥Ôºö</label>
                        <select id="bubbleDuration">
                            <option value="300">5ÂàÜÈíü</option>
                            <option value="1800">30ÂàÜÈíü</option>
                            <option value="3600">1Â∞èÊó∂</option>
                            <option value="10800">3Â∞èÊó∂</option>
                            <option value="21600">6Â∞èÊó∂</option>
                            <option value="86400">24Â∞èÊó∂</option>
                        </select>
                    </div>

                    <div class="privacy-toggle">
                        <input type="checkbox" id="privatePost">
                        <label>ËÆæ‰∏∫ÁßÅÂØÜÔºàÊ∞∏‰πÖ‰øùÂ≠òÔºâ</label>
                    </div>
                </div>

                <div id="groupPublishForm" style="display: none;">
                    <input type="text" id="groupName" placeholder="ËÅäÂ§©ÂÆ§ÂêçÁß∞ÔºàÂøÖÂ°´Ôºâ">
                    
                    <!-- Áæ§ËÅä‰ΩçÁΩÆÈÄâÊã© -->
                    <div class="location-input-group">
                        <h3 style="color: #052659; margin-bottom: 10px; font-size: 15px;">ÂèëÂ∏É‰ΩçÁΩÆ</h3>
                        <div class="location-method">
                            <button type="button" id="groupUseCurrentLocationBtn" class="active">‰ΩøÁî®ÂΩìÂâç‰ΩçÁΩÆ</button>
                            <button type="button" id="groupUseManualLocationBtn">ÊâãÂä®ËæìÂÖ•Âú∞ÂùÄ</button>
                        </div>
                        <input type="text" id="groupManualLocationInput" placeholder="ÊêúÁ¥¢Âú∞ÂùÄÔºàÂ¶ÇÔºöÂ§©ÂÆâÈó®Ôºâ" style="display: none;">
                        <div id="groupManualLocationSuggestions" class="location-suggestions" style="display: none;"></div>
                        <div id="groupSelectedLocationDisplay" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #052659;">
                            üìç ÂΩìÂâç‰ΩçÁΩÆ
                        </div>
                    </div>
                </div>

                <button class="confirm-btn" id="confirmPublishBtn">ÂèëÂ∏É</button>
            </div>
        </div>
    </div>

    <!-- ==================== Â∏ñÂ≠êËØ¶ÊÉÖÂºπÁ™ó ==================== -->
    <div id="postDetailModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('postDetailModal')">√ó</button>
            <div class="post-detail">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <div id="detailAvatar" style="width: 45px; height: 45px; border-radius: 50%; background: #5483B3; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: pointer;" onclick="visitUserProfile()">üë§</div>
                    <div>
                        <div id="detailNickname" style="font-weight: bold; color: #021024; font-size: 14px;">Áî®Êà∑ÊòµÁß∞</div>
                        <div id="detailTime" style="font-size: 11px; color: #7da0ca;">2ÂàÜÈíüÂâç</div>
                    </div>
                </div>

                <h2 id="postDetailTitle">Â∏ñÂ≠êÊ†áÈ¢ò</h2>
                <div id="postDetailContent" class="post-content"></div>

                <div class="post-actions">
                    <button class="post-action-btn" id="likeBtn">üëç ÁÇπËµû</button>
                    <button class="post-action-btn" id="collectBtn">‚≠ê Êî∂Ëóè</button>
                    <button class="post-action-btn" id="commentBtn">üí¨ ËØÑËÆ∫</button>
                    <button class="post-action-btn" id="shareBtn">üì§ ËΩ¨Âèë</button>
                    <button class="post-action-btn" id="chatBtn">üíå ÁßÅËÅä</button>
                </div>

                <!-- üîß ÂäüËÉΩ4ÔºöËØÑËÆ∫Âå∫ -->
                <div class="comments-section" id="commentsSection">
                    <h3>ËØÑËÆ∫ (<span id="commentCount">0</span>)</h3>
                    <div id="commentsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ËΩ¨ÂèëÈÄâÊã©ÂºπÁ™ó ==================== -->
    <div id="forwardModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('forwardModal')">√ó</button>
            <div class="location-select">
                <h2>ËΩ¨ÂèëÁªôÂ•ΩÂèã</h2>
                <div id="forwardFriendList"></div>
            </div>
        </div>
    </div>

    <!-- ==================== Áä∂ÊÄÅÈÄâÊã©ÂºπÁ™ó ==================== -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('statusModal')">√ó</button>
            <div class="location-select">
                <h2>ÈÄâÊã©Áä∂ÊÄÅ</h2>
                <div class="status-options">
                    <div class="status-option" data-status="free">
                        <div style="font-size: 28px; margin-bottom: 8px;">üéâ</div>
                        <div>Á©∫Èó≤ÂèØÁ∫¶</div>
                    </div>
                    <div class="status-option" data-status="onway">
                        <div style="font-size: 28px; margin-bottom: 8px;">üö∂</div>
                        <div>Ê≠£Âú®Ë∑Ø‰∏ä</div>
                    </div>
                    <div class="status-option" data-status="active">
                        <div style="font-size: 28px; margin-bottom: 8px;">üé™</div>
                        <div>Ê¥ªÂä®ing</div>
                    </div>
                    <div class="status-option" data-status="helpful">
                        <div style="font-size: 28px; margin-bottom: 8px;">ü§ù</div>
                        <div>‰πê‰∫éÂä©‰∫∫</div>
                    </div>
                    <div class="status-option" data-status="seeking">
                        <div style="font-size: 28px; margin-bottom: 8px;">üë•</div>
                        <div>ÂØªÊâæÂêå‰º¥</div>
                    </div>
                    <div class="status-option" data-status="busy">
                        <div style="font-size: 28px; margin-bottom: 8px;">üîï</div>
                        <div>ÊöÇÊó∂ÂãøÊâ∞</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== VIPÂºπÁ™ó ==================== -->
    <div id="vipModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('vipModal')">√ó</button>
            <div class="location-select">
                <h2>‰ºöÂëò‰∏≠ÂøÉ</h2>
                <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 15px; margin: 18px 0;">
                    <div style="font-size: 42px; margin-bottom: 8px;">üëë</div>
                    <div style="font-size: 22px; font-weight: bold; color: white;">VIP‰ºöÂëò</div>
                </div>

                <div class="vip-benefits">
                    <div class="vip-benefit">
                        <h4>üö´ ÂéªÈô§ÂπøÂëä</h4>
                        <p>‰∫´ÂèóÁ∫ØÂáÄ‰ΩìÈ™å</p>
                    </div>
                    <div class="vip-benefit">
                        <h4>üî• Ê∞îÊ≥°Âä†ÁÉ≠</h4>
                        <p>ÊèêÂçáÊõùÂÖâÂ∫¶</p>
                    </div>
                    <div class="vip-benefit">
                        <h4>üìä Êï∞ÊçÆÂàÜÊûê</h4>
                        <p>Â®±‰πêÂàÜÊûêÊä•Âëä</p>
                    </div>
                    <div class="vip-benefit">
                        <h4>üé® ‰∏™ÊÄßË£ÖÊâÆ</h4>
                        <p>Ëß£ÈîÅ‰∏ìÂ±ûÈ£éÊ†º</p>
                    </div>
                </div>

                <button class="confirm-btn">Á´ãÂç≥ÂºÄÈÄö</button>
            </div>
        </div>
    </div>

    <!-- ==================== Êî∂‰ª∂ÁÆ±ÂºπÁ™ó ==================== -->
    <div id="inboxModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('inboxModal')">√ó</button>
            <button class="icon-btn" id="addFriendOrGroupBtn" style="position: absolute; top: 12px; right: 12px; background: #5483B3; color: white;">‚ûï</button>
            <div class="location-select">
                <h2>Êî∂‰ª∂ÁÆ±</h2>

                <div class="inbox-tabs">
                    <div class="inbox-tab active" data-tab="likes">ÁÇπËµûÊî∂Ëóè</div>
                    <div class="inbox-tab" data-tab="comments">ËØÑËÆ∫@</div>
                    <div class="inbox-tab" data-tab="friends">Â•ΩÂèã</div>
                    <div class="inbox-tab" data-tab="groups">Áæ§ËÅä</div>
                    <div class="inbox-tab" data-tab="chats">ÁßÅËÅä</div>
                </div>

                <div class="inbox-list" id="inboxList">
                    <p style="text-align: center; color: #7da0ca; padding: 35px 0; font-size: 14px;">ÊöÇÊó†Ê∂àÊÅØ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== Ê∑ªÂä†Â•ΩÂèã/ÂèëËµ∑Áæ§ËÅäÂºπÁ™ó ==================== -->
    <div id="addFriendOrGroupModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addFriendOrGroupModal')">√ó</button>
            <div class="location-select">
                <h2>Ê∑ªÂä†Â•ΩÂèã / ÂèëËµ∑Áæ§ËÅä</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="confirm-btn" id="showAddFriendBtn" style="flex: 1; margin: 0;">Ê∑ªÂä†Â•ΩÂèã</button>
                    <button class="confirm-btn" id="showCreateGroupBtn" style="flex: 1; margin: 0;">ÂèëËµ∑Áæ§ËÅä</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== Ê∑ªÂä†Â•ΩÂèãÁïåÈù¢ÂºπÁ™ó ==================== -->
    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addFriendModal')">√ó</button>
            <div class="location-select">
                <h2>Ê∑ªÂä†Â•ΩÂèã</h2>
                <input type="text" id="searchFriendInput" placeholder="ÊêúÁ¥¢Áî®Êà∑IDÊàñÊòµÁß∞">
                <div id="searchFriendResults" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- ==================== ÂèëËµ∑Áæ§ËÅäÁïåÈù¢ÂºπÁ™ó ==================== -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('createGroupModal')">√ó</button>
            <button class="icon-btn" id="confirmCreateGroupBtn" style="position: absolute; top: 12px; right: 12px; background: #5483B3; color: white;">‚úì</button>
            <div class="location-select">
                <h2>ÂèëËµ∑Áæ§ËÅä</h2>
                <input type="text" id="groupChatName" placeholder="Áæ§ËÅäÂêçÁß∞ÔºàÈÄâÂ°´Ôºâ" style="margin-bottom: 15px;">
                <div id="friendSelectorList" class="friend-selector"></div>
            </div>
        </div>
    </div>

    <!-- ==================== Â•ΩÂèãËÅäÂ§©ÂºπÁ™ó ==================== -->
    <div id="friendChatModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeFriendChatToInbox()">√ó</button>
            <div class="chatroom">
                <div class="chatroom-header">
                    <div>
                        <div style="font-size: 16px; font-weight: bold;" id="friendChatName">Â•ΩÂèãÊòµÁß∞</div>
                    </div>
                    <button onclick="closeFriendChatToInbox()" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 18px;">√ó</button>
                </div>
                <div class="chatroom-messages" id="friendChatMessages">
                    <div class="chat-message">
                        <div class="nickname">Á≥ªÁªüÊ∂àÊÅØ</div>
                        <div class="content">ÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</div>
                    </div>
                </div>
                <div class="chatroom-input">
                    <input type="text" id="friendChatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                    <button id="sendFriendChatBtn">ÂèëÈÄÅ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== Áæ§ËÅäÂ§©ÂºπÁ™ó ==================== -->
    <div id="groupChatModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeGroupChatToInbox()">√ó</button>
            <div class="chatroom">
                <div class="chatroom-header">
                    <div>
                        <div style="font-size: 16px; font-weight: bold;" id="groupChatTitle">Áæ§ËÅäÂêçÁß∞</div>
                        <div style="font-size: 12px; margin-top: 3px;" id="groupChatMemberCount">0‰∫∫</div>
                    </div>
                    <button onclick="closeGroupChatToInbox()" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 18px;">√ó</button>
                </div>
                <div class="chatroom-messages" id="groupChatMessages">
                    <div class="chat-message">
                        <div class="nickname">Á≥ªÁªüÊ∂àÊÅØ</div>
                        <div class="content">Ê¨¢ËøéÊù•Âà∞Áæ§ËÅäÔºÅ</div>
                    </div>
                </div>
                <div class="chatroom-input">
                    <input type="text" id="groupChatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                    <button id="sendGroupChatBtn">ÂèëÈÄÅ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ËÆæÁΩÆÂºπÁ™ó ==================== -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
            <div class="location-select">
                <h2>ËÆæÁΩÆ</h2>
                <div class="settings-list">
                    <div class="settings-item" onclick="changeAvatar()">
                        <span>Â§¥ÂÉè</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="changeNickname()">
                        <span>ÊòµÁß∞</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="changeBackground()">
                        <span>ËÉåÊôØÂõæ</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="changeBio()">
                        <span>‰∏™‰∫∫ÁÆÄ‰ªã</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="changeGender()">
                        <span>ÊÄßÂà´</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="changeBirthday()">
                        <span>ÁîüÊó•</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="changeRegion()">
                        <span>Âú∞Âå∫</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="realNameAuth()">
                        <span>ÂÆûÂêçËÆ§ËØÅ</span>
                        <span style="color: #FF4444;">Êú™ËÆ§ËØÅ ‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="merchantAuth()">
                        <span>ÂïÜÂÆ∂ËÆ§ËØÅ</span>
                        <span>‚Üí</span>
                    </div>
                    <div class="settings-item" onclick="logout()" style="color: #FF4444;">
                        <span>ÈÄÄÂá∫ÁôªÂΩï</span>
                        <span>‚Üí</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ËÅäÂ§©ÂÆ§ÂºπÁ™ó ==================== -->
    <div id="chatroomModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="leaveChatroom()">√ó</button>
            <div class="chatroom">
                <div class="chatroom-header">
                    <div>
                        <div style="font-size: 16px; font-weight: bold;" id="chatroomName">ËÅäÂ§©ÂÆ§ÂêçÁß∞</div>
                        <div style="font-size: 11px; margin-top: 4px;" id="chatroomOnline">Âú®Á∫ø‰∫∫Êï∞: 1</div>
                    </div>
                    <button onclick="leaveChatroom()" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 18px;">√ó</button>
                </div>
                <div class="chatroom-messages" id="chatroomMessages">
                    <div class="chat-message">
                        <div class="nickname">Á≥ªÁªüÊ∂àÊÅØ</div>
                        <div class="content">Ê¨¢ËøéÂä†ÂÖ•ËÅäÂ§©ÂÆ§ÔºÅ</div>
                    </div>
                </div>
                <div class="chatroom-input">
                    <input type="text" id="chatroomInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                    <button id="sendChatroomBtn">ÂèëÈÄÅ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://map.qq.com/api/js?v=2.exp&key=OB4BZ-D4W3U-B7VVD-4PJWW-6TKDJ-WPB77"></script>

    <script>
        // ==================== üîß ÂÖ®Â±ÄÂèòÈáè ====================
        
        // üîß ‰øÆÊîπËøôÈáåÔºöÂ°´ÂÜô‰Ω†ÁöÑÊúçÂä°Âô®Âú∞ÂùÄ
        const SERVER_URL = 'wss://momentmap.zeabur.app';  // ‚ö†Ô∏è Êú¨Âú∞ÊµãËØïÁî®ÔºåÈÉ®ÁΩ≤Êó∂ÊîπÊàêRailwayÂú∞ÂùÄ
        const USE_SERVER = true;  // üîß ÂêØÁî®ÊúçÂä°Âô®Ê®°Âºè
        
        let socket = null;
        let mainMap = null;
        let localMap = null;
        let currentUser = null;
        let myPosition = null;
        let mainBubbles = [];
        let localBubbles = [];
        let selectedRange = 1000;
        let selectedBubbleType = null;
        let userStatus = 'free';
        let currentBubbleData = null;
        let currentGroupData = null;
        let currentLocalCenter = null;
        let currentChatroomId = null;
        let selectedLocationData = null;
        let currentLocationKey = null;
        let userLikes = [];
        let userFavorites = [];
        let userComments = [];
        let userHistory = [];
        let userPosts = [];
        let allBubbles = [];
        let friendsList = [];
        let groupsList = [];
        let currentChatFriend = null;
        let currentChatGroup = null;
        let previousScreen = 'mainScreen';
        let countdownTimer = null;
        let userNotifications = [];

        let publishUseCurrentLocation = true;
        let publishManualLocation = null;
        let groupPublishUseCurrentLocation = true;
        let groupPublishManualLocation = null;

        const statusNames = {
            free: 'Á©∫Èó≤ÂèØÁ∫¶',
            onway: 'Ê≠£Âú®Ë∑Ø‰∏ä',
            active: 'Ê¥ªÂä®ing',
            helpful: '‰πê‰∫éÂä©‰∫∫',
            seeking: 'ÂØªÊâæÂêå‰º¥',
            busy: 'ÊöÇÊó∂ÂãøÊâ∞'
        };

        // ==================== ÁΩëÁªúÁä∂ÊÄÅÊèêÁ§∫ ====================
        function showNetworkStatus(message, duration = 3000) {
            const status = document.getElementById('networkStatus');
            status.textContent = message;
            status.classList.add('show');
            
            if (duration > 0) {
                setTimeout(() => {
                    status.classList.remove('show');
                }, duration);
            }
        }

        // ==================== üîß Socket.IOËøûÊé• ====================
        function connectSocket() {
            if (!USE_SERVER) {
                console.log('üì¥ Êó†ÂêéÁ´ØÊ®°Âºè');
                document.getElementById('onlineCount').textContent = '1';
                return;
            }

            try {
                console.log('üì° ËøûÊé•ÊúçÂä°Âô®:', SERVER_URL);
                socket = io(SERVER_URL, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000
                });
                
                socket.on('connect', () => {
                    console.log('‚úÖ Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®');
                    showNetworkStatus('Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®', 2000);
                    if (currentUser) {
                        socket.emit('userJoin', currentUser);
                    }
                });
                
                socket.on('connect_error', (error) => {
                    console.error('‚ùå ËøûÊé•Â§±Ë¥•:', error);
                    showNetworkStatus('ÊúçÂä°Âô®ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú', 3000);
                });
                
                socket.on('disconnect', () => {
                    console.log('üì° ‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•');
                    showNetworkStatus('‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•', 2000);
                });
                
                socket.on('onlineCount', (count) => {
                    document.getElementById('onlineCount').textContent = count;
                });

                // üîß Êé•Êî∂ÊâÄÊúâÊ∞îÊ≥°
                socket.on('allBubbles', (bubbles) => {
                    console.log('üì• Êî∂Âà∞ÊâÄÊúâÊ∞îÊ≥°:', bubbles.length);
                    allBubbles = bubbles;
                    if (mainMap && myPosition) {
                        bubbles.forEach(bubble => {
                            const distance = calculateDistance(
                                myPosition.lat, myPosition.lng,
                                bubble.lat, bubble.lng
                            );
                            if (distance < 5000) {
                                createBubbleOnMap(mainMap, mainBubbles, bubble, false);
                            }
                        });
                    }
                });

                // üîß Êé•Êî∂Êñ∞Ê∞îÊ≥°
                socket.on('newBubble', (bubble) => {
                    console.log('üì• Êî∂Âà∞Êñ∞Ê∞îÊ≥°:', bubble.title);
                    allBubbles.push(bubble);
                    
                    if (mainMap && myPosition) {
                        const distance = calculateDistance(
                            myPosition.lat, myPosition.lng,
                            bubble.lat, bubble.lng
                        );
                        if (distance < 5000) {
                            createBubbleOnMap(mainMap, mainBubbles, bubble, false);
                        }
                    }
                    
                    if (localMap && currentLocalCenter) {
                        const distance = calculateDistance(
                            currentLocalCenter.lat, currentLocalCenter.lng,
                            bubble.lat, bubble.lng
                        );
                        if (distance < selectedRange) {
                            createBubbleOnMap(localMap, localBubbles, bubble, false);
                        }
                    }
                });

                // üîß Ê∞îÊ≥°ËøáÊúü
                socket.on('bubbleExpired', (bubbleId) => {
                    console.log('‚è∞ Ê∞îÊ≥°ËøáÊúü:', bubbleId);
                    removeBubbleFromMap(mainBubbles, bubbleId);
                    removeBubbleFromMap(localBubbles, bubbleId);
                    allBubbles = allBubbles.filter(b => b.id !== bubbleId);
                });

                // üîß ÂäüËÉΩ1ÔºöÊé•Êî∂ÈÄöÁü•
                socket.on('newNotification', (notification) => {
                    console.log('üì¨ Êî∂Âà∞Êñ∞ÈÄöÁü•:', notification);
                    userNotifications.unshift(notification);
                    showNetworkStatus('Êî∂Âà∞Êñ∞ÈÄöÁü•', 2000);
                });

                socket.on('allNotifications', (notifications) => {
                    console.log('üì¨ Êî∂Âà∞ÊâÄÊúâÈÄöÁü•:', notifications.length);
                    userNotifications = notifications;
                });

                // üîß ÂäüËÉΩ4ÔºöËØÑËÆ∫Êõ¥Êñ∞
                socket.on('bubbleCommentAdded', ({ bubbleId, comment }) => {
                    console.log('üí¨ Ê∞îÊ≥°ËØÑËÆ∫Êõ¥Êñ∞:', bubbleId);
                    const bubble = allBubbles.find(b => b.id === bubbleId);
                    if (bubble) {
                        if (!bubble.comments) bubble.comments = [];
                        bubble.comments.push(comment);
                        
                        // Â¶ÇÊûúÊ≠£Âú®Êü•ÁúãËøô‰∏™Â∏ñÂ≠êÔºåÊõ¥Êñ∞ËØÑËÆ∫Âå∫
                        if (currentBubbleData && currentBubbleData.id === bubbleId) {
                            updateCommentsDisplay(bubble.comments);
                        }
                    }
                });

                // üîß ÂäüËÉΩ2ÔºöÂ•ΩÂèãÂàóË°®Êõ¥Êñ∞
                socket.on('friendListUpdate', () => {
                    console.log('üë• Â•ΩÂèãÂàóË°®Êõ¥Êñ∞');
                    loadFriendsList();
                });

                // üîß ÂäüËÉΩ3ÔºöÁæ§ËÅäÂàõÂª∫ÊàêÂäü
                socket.on('groupChatCreated', ({ groupId, groupName, members }) => {
                    console.log('üë• Áæ§ËÅäÂàõÂª∫ÊàêÂäü:', groupName);
                    groupsList.push({ id: groupId, name: groupName, members });
                    showNetworkStatus('Áæ§ËÅäÂàõÂª∫ÊàêÂäü', 2000);
                });

                // üîß ÂäüËÉΩ5ÔºöÁßÅËÅäÊ∂àÊÅØ
                socket.on('privateMessage', (msg) => {
                    console.log('üíå Êî∂Âà∞ÁßÅËÅäÊ∂àÊÅØ:', msg);
                    
                    // Â¶ÇÊûúÊ≠£Âú®Ë∑üËøô‰∏™‰∫∫ËÅäÂ§©ÔºåÁõ¥Êé•ÊòæÁ§∫
                    if (currentChatFriend && 
                        (currentChatFriend.userId === msg.from || currentChatFriend.userId === msg.to)) {
                        displayPrivateMessage(msg);
                    } else {
                        showNetworkStatus(`${msg.fromNickname} ÂèëÊù•Êñ∞Ê∂àÊÅØ`, 2000);
                    }
                });

                socket.on('privateChatHistory', (messages) => {
                    console.log('üìú ÁßÅËÅäÂéÜÂè≤:', messages.length);
                    displayPrivateChatHistory(messages);
                });

                socket.on('privateMessageSent', (msg) => {
                    console.log('‚úÖ Ê∂àÊÅØÂèëÈÄÅÊàêÂäü');
                    displayPrivateMessage(msg);
                });

                // üîß ÂäüËÉΩ6ÔºöËΩ¨ÂèëÊàêÂäü
                socket.on('forwardSuccess', ({ toUserId }) => {
                    console.log('‚úÖ ËΩ¨ÂèëÊàêÂäü');
                    showNetworkStatus('ËΩ¨ÂèëÊàêÂäü', 2000);
                    closeModal('forwardModal');
                });

                // üîß Â•ΩÂèãÂàóË°®
                socket.on('friendsList', (friends) => {
                    console.log('üë• Â•ΩÂèãÂàóË°®:', friends.length);
                    friendsList = friends;
                    if (document.getElementById('inboxModal').style.display === 'flex') {
                        loadInboxContent('friends');
                    }
                });

                // üîß Áæ§ËÅäÂàóË°®
                socket.on('groupChatsList', (groups) => {
                    console.log('üë• Áæ§ËÅäÂàóË°®:', groups.length);
                    groupsList = groups;
                    if (document.getElementById('inboxModal').style.display === 'flex') {
                        loadInboxContent('groups');
                    }
                });

                // üîß Áæ§ËÅäÊ∂àÊÅØ
                socket.on('groupMessage', ({ groupId, message }) => {
                    console.log('üí¨ Áæ§ËÅäÊ∂àÊÅØ:', groupId);
                    
                    if (currentChatGroup && currentChatGroup.id === groupId) {
                        displayGroupMessage(message);
                    } else {
                        showNetworkStatus('Áæ§ËÅäÊúâÊñ∞Ê∂àÊÅØ', 2000);
                    }
                });

                socket.on('groupMessagesHistory', ({ groupId, messages }) => {
                    console.log('üìú Áæ§ËÅäÂéÜÂè≤:', messages.length);
                    displayGroupChatHistory(messages);
                });

                // üîß ËÅäÂ§©ÂÆ§Ê∂àÊÅØ
                socket.on('chatroomHistory', (messages) => {
                    console.log('üìú ËÅäÂ§©ÂÆ§ÂéÜÂè≤:', messages.length);
                    const container = document.getElementById('chatroomMessages');
                    container.innerHTML = '';
                    messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'chat-message';
                        div.innerHTML = `
                            <div class="nickname">${msg.nickname}</div>
                            <div class="content">${msg.content}</div>
                        `;
                        container.appendChild(div);
                    });
                    container.scrollTop = container.scrollHeight;
                });

                socket.on('chatroomMessage', (msg) => {
                    console.log('üí¨ ËÅäÂ§©ÂÆ§Ê∂àÊÅØ:', msg);
                    const container = document.getElementById('chatroomMessages');
                    const div = document.createElement('div');
                    div.className = 'chat-message';
                    div.innerHTML = `
                        <div class="nickname">${msg.nickname}</div>
                        <div class="content">${msg.content}</div>
                    `;
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                });

                socket.on('chatroomOnline', (count) => {
                    document.getElementById('chatroomOnline').textContent = `Âú®Á∫ø‰∫∫Êï∞: ${count}`;
                });

            } catch (error) {
                console.error('Socket ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                showNetworkStatus('ÁΩëÁªúËøûÊé•Â§±Ë¥•', 3000);
            }
        }

        // ËÆ°ÁÆóË∑ùÁ¶ªÔºàÁ±≥Ôºâ
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ==================== ÂàùÂßãÂåñ ====================
        window.onload = function() {
            showScreen('loginScreen');
            initEventListeners();
            
            if (USE_SERVER) {
                connectSocket();
            } else {
                loadLocalData();
                document.getElementById('onlineCount').textContent = '1';
            }
        };

        // ==================== Êú¨Âú∞Â≠òÂÇ® ====================
        function saveLocalData() {
            try {
                localStorage.setItem('momentmap_user', JSON.stringify({
                    likes: userLikes,
                    favorites: userFavorites,
                    comments: userComments,
                    history: userHistory,
                    posts: userPosts,
                    friends: friendsList,
                    avatar: currentUser ? currentUser.avatar : null,
                    avatarImg: currentUser ? currentUser.avatarImg : null,
                    nickname: currentUser ? currentUser.nickname : null,
                    backgroundImg: currentUser ? currentUser.backgroundImg : null
                }));
            } catch (error) {
                console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        function loadLocalData() {
            try {
                const userData = localStorage.getItem('momentmap_user');
                
                if (userData) {
                    const data = JSON.parse(userData);
                    userLikes = data.likes || [];
                    userFavorites = data.favorites || [];
                    userComments = data.comments || [];
                    userHistory = data.history || [];
                    userPosts = data.posts || [];
                    friendsList = data.friends || [];
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // ==================== ÁïåÈù¢ÂàáÊç¢ ====================
        function showScreen(screenId) {
            const screens = ['loginScreen', 'mainScreen', 'profileScreen', 'localScreen'];
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === screenId) {
                        element.style.display = 'block';
                    } else {
                        element.style.display = 'none';
                    }
                }
            });

            if (screenId !== 'profileScreen') {
                previousScreen = screenId;
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function closeFriendChatToInbox() {
            closeModal('friendChatModal');
            openModal('inboxModal');
        }

        function closeGroupChatToInbox() {
            closeModal('groupChatModal');
            openModal('inboxModal');
        }

        function logout() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                currentUser = null;
                myPosition = null;
                
                if (socket && socket.connected) {
                    socket.disconnect();
                }
                
                if (mainMap) {
                    mainBubbles.forEach(item => {
                        if (item.marker) item.marker.setMap(null);
                        if (item.label) item.label.setMap(null);
                    });
                    mainBubbles = [];
                }
                
                if (localMap) {
                    localBubbles.forEach(item => {
                        if (item.marker) item.marker.setMap(null);
                        if (item.label) item.label.setMap(null);
                    });
                    localBubbles = [];
                }
                
                closeModal('settingsModal');
                
                showScreen('loginScreen');
                document.getElementById('onlineBadge').style.display = 'none';
                
                document.getElementById('phoneInput').value = '';
                document.getElementById('codeInput').value = '';
                
                showNetworkStatus('Â∑≤ÈÄÄÂá∫ÁôªÂΩï', 2000);
            }
        }

        // ==================== ‰∫ã‰ª∂ÁõëÂê¨ ====================
        function initEventListeners() {
            document.getElementById('getCodeBtn').onclick = getVerifyCode;
            document.getElementById('loginBtn').onclick = login;
            
            document.getElementById('profileBtn').onclick = () => {
                previousScreen = 'mainScreen';
                showScreen('profileScreen');
            };
            
            document.getElementById('localAreaBtn').onclick = () => openModal('locationModal');
            
            document.getElementById('profileBackBtn').onclick = () => showScreen(previousScreen);
            
            document.getElementById('inboxBtn').onclick = () => {
                loadFriendsList();
                loadGroupsList();
                loadInboxContent('likes');
                openModal('inboxModal');
            };
            document.getElementById('settingsBtn').onclick = () => openModal('settingsModal');
            document.getElementById('statusBtn').onclick = () => openModal('statusModal');
            document.getElementById('vipBtn').onclick = () => openModal('vipModal');
            
            document.getElementById('localProfileBtn').onclick = () => {
                previousScreen = 'localScreen';
                showScreen('profileScreen');
            };
            
            document.getElementById('localBackBtn').onclick = () => {
                showScreen('mainScreen');
            };
            document.getElementById('publishBtn').onclick = () => openModal('publishModal');
            document.getElementById('discoverBtn').onclick = () => openModal('filterModal');

            document.querySelectorAll('.range-option').forEach(opt => {
                opt.onclick = function() {
                    document.querySelectorAll('.range-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedRange = parseInt(this.dataset.range);
                };
            });
            document.getElementById('confirmLocationBtn').onclick = enterLocalArea;
            document.getElementById('locationInput').oninput = searchLocation;

            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.onclick = function() {
                    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const searchBox = document.getElementById('profileSearch');
                    if (this.dataset.tab === 'search') {
                        searchBox.classList.add('active');
                    } else {
                        searchBox.classList.remove('active');
                    }
                    
                    loadProfileContent(this.dataset.tab);
                };
            });

            document.getElementById('profileSearchInput').oninput = function() {
                const keyword = this.value.trim().toLowerCase();
                if (!keyword) {
                    document.getElementById('profileContent').innerHTML = '<p style="color: #7da0ca; text-align: center; padding: 40px 0;">ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç</p>';
                    return;
                }
                
                const allItems = [...userPosts, ...userLikes, ...userFavorites, ...userHistory];
                const results = allItems.filter(item => 
                    item.title.toLowerCase().includes(keyword) || 
                    (item.content && item.content.toLowerCase().includes(keyword))
                );
                
                displayPostList(results, 'ÊêúÁ¥¢ÁªìÊûú');
            };

            initPublishTags();
            initPublishLocationSelect();
            document.getElementById('confirmPublishBtn').onclick = publishBubble;

            initFilterTags();
            document.getElementById('confirmFilterBtn').onclick = applyFilter;
            document.getElementById('clearFilterBtn').onclick = clearFilter;

            document.querySelectorAll('.status-option').forEach(opt => {
                opt.onclick = function() {
                    document.querySelectorAll('.status-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    userStatus = this.dataset.status;
                    document.getElementById('statusBtn').textContent = statusNames[userStatus];
                    closeModal('statusModal');
                };
            });

            document.getElementById('sendChatroomBtn').onclick = sendChatroomMessage;
            document.getElementById('chatroomInput').onkeypress = function(e) {
                if (e.key === 'Enter') sendChatroomMessage();
            };

            // üîß ÂäüËÉΩ1ÔºöÁÇπËµû
            document.getElementById('likeBtn').onclick = () => {
                if (!currentBubbleData) return;
                
                if (USE_SERVER && socket) {
                    socket.emit('likeBubble', {
                        bubbleId: currentBubbleData.id,
                        userId: currentUser.id,
                        userNickname: currentUser.nickname
                    });
                }
                
                const index = userLikes.findIndex(item => item.id === currentBubbleData.id);
                if (index > -1) {
                    userLikes.splice(index, 1);
                    showNetworkStatus('Â∑≤ÂèñÊ∂àÁÇπËµû', 1500);
                    document.getElementById('likeBtn').textContent = 'üëç ÁÇπËµû';
                } else {
                    userLikes.push({...currentBubbleData, actionTime: Date.now()});
                    showNetworkStatus('Â∑≤ÁÇπËµû', 1500);
                    document.getElementById('likeBtn').textContent = '‚ù§Ô∏è Â∑≤ÁÇπËµû';
                }
                saveLocalData();
            };

            // üîß ÂäüËÉΩ1ÔºöÊî∂Ëóè
            document.getElementById('collectBtn').onclick = () => {
                if (!currentBubbleData) return;
                
                if (USE_SERVER && socket) {
                    socket.emit('favoriteBubble', {
                        bubbleId: currentBubbleData.id,
                        userId: currentUser.id,
                        userNickname: currentUser.nickname
                    });
                }
                
                const index = userFavorites.findIndex(item => item.id === currentBubbleData.id);
                if (index > -1) {
                    userFavorites.splice(index, 1);
                    showNetworkStatus('Â∑≤ÂèñÊ∂àÊî∂Ëóè', 1500);
                    document.getElementById('collectBtn').textContent = '‚≠ê Êî∂Ëóè';
                } else {
                    userFavorites.push({...currentBubbleData, actionTime: Date.now()});
                    showNetworkStatus('Â∑≤Êî∂Ëóè', 1500);
                    document.getElementById('collectBtn').textContent = '‚≠ê Â∑≤Êî∂Ëóè';
                }
                saveLocalData();
            };

            // üîß ÂäüËÉΩ1&4ÔºöËØÑËÆ∫
            document.getElementById('commentBtn').onclick = () => {
                if (!currentBubbleData) return;
                const comment = prompt('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπÔºö');
                if (comment && comment.trim()) {
                    if (USE_SERVER && socket) {
                        socket.emit('commentBubble', {
                            bubbleId: currentBubbleData.id,
                            userId: currentUser.id,
                            userNickname: currentUser.nickname,
                            comment: comment.trim()
                        });
                    }
                    
                    userComments.push({...currentBubbleData, comment: comment.trim(), actionTime: Date.now()});
                    showNetworkStatus('ËØÑËÆ∫ÊàêÂäü', 1500);
                    saveLocalData();
                }
            };

            // üîß ÂäüËÉΩ6ÔºöËΩ¨Âèë
            document.getElementById('shareBtn').onclick = () => {
                if (!currentBubbleData) return;
                showForwardModal();
            };

            // üîß ÂäüËÉΩ5ÔºöÁßÅËÅä
            document.getElementById('chatBtn').onclick = () => {
                if (!currentBubbleData) return;
                openPrivateChatWithAuthor();
            };

            document.getElementById('viewDetailBtn').onclick = () => {
                closeBubblePreview();
                showPostDetail(currentBubbleData);
            };

            document.getElementById('joinGroupBtn').onclick = joinGroup;

            document.getElementById('addFriendOrGroupBtn').onclick = () => openModal('addFriendOrGroupModal');
            document.getElementById('showAddFriendBtn').onclick = () => {
                closeModal('addFriendOrGroupModal');
                openModal('addFriendModal');
            };
            document.getElementById('showCreateGroupBtn').onclick = () => {
                closeModal('addFriendOrGroupModal');
                loadFriendSelector();
                openModal('createGroupModal');
            };

            // üîß ÂäüËÉΩ2ÔºöÊêúÁ¥¢Â•ΩÂèã
            document.getElementById('searchFriendInput').oninput = searchFriend;
            
            document.getElementById('confirmCreateGroupBtn').onclick = confirmCreateGroup;
            
            // üîß ÂäüËÉΩ5ÔºöÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØ
            document.getElementById('sendFriendChatBtn').onclick = sendFriendChatMessage;
            document.getElementById('friendChatInput').onkeypress = function(e) {
                if (e.key === 'Enter') sendFriendChatMessage();
            };

            // üîß ÂäüËÉΩ3ÔºöÂèëÈÄÅÁæ§ËÅäÊ∂àÊÅØ
            document.getElementById('sendGroupChatBtn').onclick = sendGroupChatMessage;
            document.getElementById('groupChatInput').onkeypress = function(e) {
                if (e.key === 'Enter') sendGroupChatMessage();
            };

            document.querySelectorAll('.inbox-tab').forEach(tab => {
                tab.onclick = function() {
                    document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadInboxContent(this.dataset.tab);
                };
            });
        }

        // ==================== üîß ÂäüËÉΩ5ÔºöÊâìÂºÄ‰∏é‰ΩúËÄÖÁöÑÁßÅËÅä ====================
        function openPrivateChatWithAuthor() {
            if (!currentBubbleData || !currentBubbleData.authorId) {
                showNetworkStatus('Êó†Ê≥ïËé∑Âèñ‰ΩúËÄÖ‰ø°ÊÅØ', 2000);
                return;
            }
            
            // ÂàõÂª∫Â•ΩÂèãÂØπË±°
            currentChatFriend = {
                userId: currentBubbleData.authorId,
                nickname: currentBubbleData.author,
                avatar: 'üë§'
            };
            
            closeModal('postDetailModal');
            openPrivateChat(currentChatFriend);
        }

        // ==================== üîß ÂäüËÉΩ6ÔºöÊòæÁ§∫ËΩ¨ÂèëÂºπÁ™ó ====================
        function showForwardModal() {
            const listDiv = document.getElementById('forwardFriendList');
            
            if (friendsList.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 20px;">ÊöÇÊó†Â•ΩÂèã</p>';
            } else {
                listDiv.innerHTML = friendsList.map(friend => `
                    <div class="friend-item" onclick="forwardToFriend('${friend.userId}', '${friend.nickname}')">
                        <div class="friend-avatar">${friend.avatar || 'üë§'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.nickname}</div>
                            <div class="friend-status">${statusNames[friend.status] || 'Á¶ªÁ∫ø'}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            openModal('forwardModal');
        }

        function forwardToFriend(toUserId, toNickname) {
            if (!currentBubbleData) return;
            
            if (USE_SERVER && socket) {
                socket.emit('forwardBubble', {
                    bubbleId: currentBubbleData.id,
                    fromUserId: currentUser.id,
                    toUserId: toUserId,
                    fromUserNickname: currentUser.nickname
                });
            } else {
                showNetworkStatus(`Â∑≤ËΩ¨ÂèëÁªô ${toNickname}`, 2000);
                closeModal('forwardModal');
            }
        }

        // ==================== üîß ÂäüËÉΩ4ÔºöÊõ¥Êñ∞ËØÑËÆ∫ÊòæÁ§∫ ====================
        function updateCommentsDisplay(comments) {
            const commentsSection = document.getElementById('commentsSection');
            const commentsList = document.getElementById('commentsList');
            const commentCount = document.getElementById('commentCount');
            
            if (!comments || comments.length === 0) {
                commentsList.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 20px;">ÊöÇÊó†ËØÑËÆ∫</p>';
                commentCount.textContent = '0';
                return;
            }
            
            commentCount.textContent = comments.length;
            commentsList.innerHTML = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-author">${comment.userNickname}</div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-time">${formatTime(comment.time)}</div>
                </div>
            `).join('');
        }

        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return 'ÂàöÂàö';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            return Math.floor(diff / 86400000) + 'Â§©Ââç';
        }

        // ==================== üîß ÂäüËÉΩ5ÔºöÁßÅËÅäÂäüËÉΩ ====================
        function openPrivateChat(friend) {
            currentChatFriend = friend;
            document.getElementById('friendChatName').textContent = friend.nickname;
            
            // Ê∏ÖÁ©∫Ê∂àÊÅØ
            document.getElementById('friendChatMessages').innerHTML = `
                <div class="chat-message">
                    <div class="nickname">Á≥ªÁªüÊ∂àÊÅØ</div>
                    <div class="content">ÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</div>
                </div>
            `;
            
            // ËØ∑Ê±ÇÂéÜÂè≤Ê∂àÊÅØ
            if (USE_SERVER && socket) {
                socket.emit('getPrivateChat', {
                    userId1: currentUser.id,
                    userId2: friend.userId
                });
            }
            
            closeModal('inboxModal');
            openModal('friendChatModal');
        }

        function displayPrivateChatHistory(messages) {
            const container = document.getElementById('friendChatMessages');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="chat-message">
                        <div class="nickname">Á≥ªÁªüÊ∂àÊÅØ</div>
                        <div class="content">ÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</div>
                    </div>
                `;
                return;
            }
            
            messages.forEach(msg => {
                displayPrivateMessage(msg);
            });
        }

        function displayPrivateMessage(msg) {
            const container = document.getElementById('friendChatMessages');
            const div = document.createElement('div');
            div.className = 'chat-message';
            
            let content = msg.content;
            
            // üîß ÂäüËÉΩ6ÔºöÊòæÁ§∫ËΩ¨ÂèëÁöÑÊ∞îÊ≥°
            if (msg.type === 'forward' && msg.bubbleData) {
                content = `
                    <div class="chat-forward">
                        <div class="chat-forward-title">[ËΩ¨Âèë] ${msg.bubbleData.title}</div>
                        <div class="chat-forward-content">${msg.bubbleData.content || ''}</div>
                    </div>
                `;
            }
            
            div.innerHTML = `
                <div class="nickname">${msg.fromNickname}</div>
                <div class="content">${content}</div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendFriendChatMessage() {
            const input = document.getElementById('friendChatInput');
            const message = input.value.trim();
            
            if (!message || !currentChatFriend) return;
            
            if (USE_SERVER && socket) {
                socket.emit('sendPrivateMessage', {
                    fromUserId: currentUser.id,
                    toUserId: currentChatFriend.userId,
                    fromUserNickname: currentUser.nickname,
                    message: message
                });
            } else {
                // Êú¨Âú∞Ê®°Âºè
                displayPrivateMessage({
                    fromNickname: currentUser.nickname,
                    content: message,
                    time: Date.now()
                });
            }
            
            input.value = '';
        }

        // ==================== üîß ÂäüËÉΩ3ÔºöÁæ§ËÅäÂäüËÉΩ ====================
        function openGroupChat(group) {
            currentChatGroup = group;
            document.getElementById('groupChatTitle').textContent = group.name;
            document.getElementById('groupChatMemberCount').textContent = `${group.memberCount || 0}‰∫∫`;
            
            // Ê∏ÖÁ©∫Ê∂àÊÅØ
            document.getElementById('groupChatMessages').innerHTML = `
                <div class="chat-message">
                    <div class="nickname">Á≥ªÁªüÊ∂àÊÅØ</div>
                    <div class="content">Ê¨¢ËøéÊù•Âà∞Áæ§ËÅäÔºÅ</div>
                </div>
            `;
            
            // ËØ∑Ê±ÇÂéÜÂè≤Ê∂àÊÅØ
            if (USE_SERVER && socket) {
                socket.emit('getGroupMessages', { groupId: group.id });
            }
            
            closeModal('inboxModal');
            openModal('groupChatModal');
        }

        function displayGroupChatHistory(messages) {
            const container = document.getElementById('groupChatMessages');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="chat-message">
                        <div class="nickname">Á≥ªÁªüÊ∂àÊÅØ</div>
                        <div class="content">Ê¨¢ËøéÊù•Âà∞Áæ§ËÅäÔºÅ</div>
                    </div>
                `;
                return;
            }
            
            messages.forEach(msg => {
                displayGroupMessage(msg);
            });
        }

        function displayGroupMessage(msg) {
            const container = document.getElementById('groupChatMessages');
            const div = document.createElement('div');
            div.className = 'chat-message';
            div.innerHTML = `
                <div class="nickname">${msg.nickname}</div>
                <div class="content">${msg.content}</div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendGroupChatMessage() {
            const input = document.getElementById('groupChatInput');
            const message = input.value.trim();
            
            if (!message || !currentChatGroup) return;
            
            if (USE_SERVER && socket) {
                socket.emit('sendGroupMessage', {
                    groupId: currentChatGroup.id,
                    userId: currentUser.id,
                    userNickname: currentUser.nickname,
                    message: message
                });
            } else {
                displayGroupMessage({
                    nickname: currentUser.nickname,
                    content: message,
                    time: Date.now()
                });
            }
            
            input.value = '';
        }

        // ==================== È™åËØÅÁ†ÅÂÄíËÆ°Êó∂ ====================
        function getVerifyCode() {
            const phone = document.getElementById('phoneInput').value;
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showNetworkStatus('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑', 2000);
                return;
            }

            const btn = document.getElementById('getCodeBtn');
            btn.disabled = true;
            
            let countdown = 60;
            btn.textContent = `ÈáçÊñ∞Ëé∑Âèñ(${countdown}s)`;
            
            countdownTimer = setInterval(() => {
                countdown--;
                btn.textContent = `ÈáçÊñ∞Ëé∑Âèñ(${countdown}s)`;
                
                if (countdown <= 0) {
                    clearInterval(countdownTimer);
                    btn.disabled = false;
                    btn.textContent = 'Ëé∑ÂèñÈ™åËØÅÁ†Å';
                }
            }, 1000);
            
            showNetworkStatus('È™åËØÅÁ†ÅÂ∑≤ÂèëÈÄÅÔºàÊµãËØïÊ®°ÂºèÔºö123456Ôºâ', 3000);
        }

        async function login() {
            const phone = document.getElementById('phoneInput').value;
            const code = document.getElementById('codeInput').value;
            
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showNetworkStatus('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑', 2000);
                return;
            }
            
            if (code !== '123456') {
                showNetworkStatus('È™åËØÅÁ†ÅÈîôËØØÔºàÊµãËØïÔºö123456Ôºâ', 2000);
                return;
            }

            const userData = localStorage.getItem('momentmap_user');
            let savedData = {};
            if (userData) {
                savedData = JSON.parse(userData);
            }

            currentUser = {
                phone: phone,
                nickname: savedData.nickname || ('Áî®Êà∑' + phone.substr(-4)),
                id: 'USER' + Date.now(),
                avatar: savedData.avatar || 'üë§',
                avatarImg: savedData.avatarImg || null,
                backgroundImg: savedData.backgroundImg || null,
                status: 'free'
            };

            showNetworkStatus('Ê≠£Âú®Ëé∑Âèñ‰ΩçÁΩÆ...', 0);
            await getUserLocation();
            
            if (myPosition && myPosition.lat && myPosition.lng) {
                await initMaps();
                updateProfileDisplay();
                
                if (USE_SERVER && socket && socket.connected) {
                    socket.emit('userJoin', currentUser);
                }
                
                showScreen('mainScreen');
                document.getElementById('onlineBadge').style.display = 'block';
                showNetworkStatus('ÁôªÂΩïÊàêÂäü', 2000);
            } else {
                showNetworkStatus('Ëé∑Âèñ‰ΩçÁΩÆÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï', 3000);
            }
        }

        function updateProfileDisplay() {
            if (currentUser) {
                document.getElementById('profileNickname').textContent = currentUser.nickname;
                document.getElementById('profileId').textContent = 'ID: ' + currentUser.id;
                document.getElementById('statusBtn').textContent = statusNames[userStatus];
                
                const avatarElement = document.getElementById('profileAvatar');
                if (currentUser.avatarImg) {
                    avatarElement.innerHTML = `<img src="${currentUser.avatarImg}" alt="Â§¥ÂÉè">`;
                } else {
                    avatarElement.textContent = currentUser.avatar;
                }

                const profileScreen = document.getElementById('profileScreen');
                if (currentUser.backgroundImg) {
                    profileScreen.style.backgroundImage = `url(${currentUser.backgroundImg})`;
                    profileScreen.classList.add('has-background');
                } else {
                    profileScreen.style.backgroundImage = '';
                    profileScreen.classList.remove('has-background');
                }
            }
        }

        // ==================== GPSÂÆö‰Ωç ====================
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    console.log('‚ö†Ô∏è ÊµèËßàÂô®‰∏çÊîØÊåÅGeolocationÔºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆ');
                    myPosition = { lat: 39.9042, lng: 116.4074 };
                    showNetworkStatus('ÊµèËßàÂô®‰∏çÊîØÊåÅÂÆö‰ΩçÔºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆÔºàÂåó‰∫¨Â§©ÂÆâÈó®Ôºâ', 3000);
                    resolve(myPosition);
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        myPosition = { lat: lat, lng: lng };
                        console.log('‚úÖ Ëé∑ÂèñÂà∞GPSÂÆö‰Ωç:', myPosition);
                        showNetworkStatus(`ÂÆö‰ΩçÊàêÂäü (Á≤æÂ∫¶: ${Math.round(position.coords.accuracy)}Á±≥)`, 2000);
                        resolve(myPosition);
                    },
                    (error) => {
                        console.log('‚ö†Ô∏è ÂÆö‰ΩçÂ§±Ë¥•:', error.message);
                        
                        let errorMessage = 'ÂÆö‰ΩçÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆÔºàÂåó‰∫¨Â§©ÂÆâÈó®Ôºâ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'ËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏‰ΩçÁΩÆÊùÉÈôêÔºåÁÑ∂ÂêéÂà∑Êñ∞È°µÈù¢';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Êó†Ê≥ïËé∑Âèñ‰ΩçÁΩÆ‰ø°ÊÅØÔºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆ';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'ÂÆö‰ΩçË∂ÖÊó∂Ôºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆ';
                                break;
                        }
                        
                        showNetworkStatus(errorMessage, 4000);
                        myPosition = { lat: 39.9042, lng: 116.4074 };
                        resolve(myPosition);
                    },
                    options
                );
            });
        }

        // ==================== ‰∏ªÂú∞ÂõæÂàùÂßãÂåñ ====================
        async function initMaps() {
            if (!myPosition || !myPosition.lat || !myPosition.lng) {
                console.error('‚ùå myPosition ‰∏∫Á©∫ÔºåÊó†Ê≥ïÂàùÂßãÂåñÂú∞Âõæ');
                showNetworkStatus('‰ΩçÁΩÆ‰ø°ÊÅØÊó†ÊïàÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 3000);
                return;
            }

            mainMap = new qq.maps.Map(document.getElementById('map'), {
                center: new qq.maps.LatLng(myPosition.lat, myPosition.lng),
                zoom: 13
            });

            // üîß ÂäüËÉΩ9ÔºöÂè™Âú®Áî®Êà∑‰ΩçÁΩÆÊòæÁ§∫ÂÆö‰ΩçÊ†áÂøó
            new qq.maps.Marker({
                map: mainMap,
                position: new qq.maps.LatLng(myPosition.lat, myPosition.lng),
                title: 'ÊàëÁöÑ‰ΩçÁΩÆ'
            });

            console.log('‚è≥ Á≠âÂæÖ‰ªéÊúçÂä°Âô®Êé•Êî∂Ê∞îÊ≥°Êï∞ÊçÆ...');
        }

        function getRandomPosition(center, radiusInMeters) {
            if (!center) {
                console.error('‚ùå center ‰∏∫Á©∫');
                return null;
            }
            
            const lat = center.lat || (center.getLat ? center.getLat() : null);
            const lng = center.lng || (center.getLng ? center.getLng() : null);
            
            if (!lat || !lng) {
                console.error('‚ùå Êó†Ê≥ï‰ªé center Ëé∑ÂèñÁªèÁ∫¨Â∫¶');
                return null;
            }
            
            const radiusInDegrees = radiusInMeters / 111000;
            const u = Math.random();
            const v = Math.random();
            const w = radiusInDegrees * Math.sqrt(u);
            const t = 2 * Math.PI * v;
            const x = w * Math.cos(t);
            const y = w * Math.sin(t);
            return { lat: lat + y, lng: lng + x };
        }

        function removeBubbleFromMap(bubbleList, bubbleId) {
            const index = bubbleList.findIndex(b => b.bubble.id === bubbleId);
            if (index > -1) {
                const item = bubbleList[index];
                if (item.marker && item.marker.setMap) item.marker.setMap(null);
                if (item.label && item.label.setMap) item.label.setMap(null);
                bubbleList.splice(index, 1);
            }
        }

function createBubbleOnMap(map, bubbleList, bubbleData, autoDisappear) {
    const icons = {
        recommend: 'üëç',
        help: 'üÜò',
        team: 'üë•',
        warning: '‚ö†Ô∏è',
        group: 'üí¨',
        news: 'üì∞'
    };

    // ‚úÖ Âè™ÂàõÂª∫Ê∞îÊ≥°LabelÔºå‰∏çÂàõÂª∫ËìùËâ≤Marker
    const label = new qq.maps.Label({
        position: new qq.maps.LatLng(bubbleData.lat, bubbleData.lng),
        map: map,
        content: `<div class="bubble bubble-${bubbleData.type}" data-bubble-id="${bubbleData.id}">${icons[bubbleData.type]}</div>`,
        style: { border: 'none', background: 'transparent' }
    });

    const clickHandler = function() {
        onBubbleClick(bubbleData, label);
    };

    qq.maps.event.addListener(label, 'click', clickHandler);

    // ‚úÖ markerËÆæ‰∏∫null
    bubbleList.push({ bubble: bubbleData, marker: null, label });

    if (autoDisappear) {
        setTimeout(() => {
            removeBubbleFromMap(bubbleList, bubbleData.id);
        }, 10000);
    }
}

        // ==================== üîß ÂäüËÉΩ7&8Ôºö‰øÆÂ§çÂú∞ÁÇπÊêúÁ¥¢ ====================
        function searchLocation() {
            const input = document.getElementById('locationInput').value.trim();
            const suggestionsDiv = document.getElementById('locationSuggestions');
            
            if (!input) {
                suggestionsDiv.innerHTML = '';
                return;
            }

            if (USE_SERVER && SERVER_URL) {
                fetch(`${SERVER_URL}/api/search?keyword=${encodeURIComponent(input)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 0 && data.data && data.data.length > 0) {
                            const html = data.data.slice(0, 5).map(item => {
                                return `<div class="suggestion-item" data-location='${JSON.stringify(item)}'>${item.title} - ${item.address || ''}</div>`;
                            }).join('');
                            suggestionsDiv.innerHTML = html;
                            
                            document.querySelectorAll('#locationSuggestions .suggestion-item').forEach(el => {
                                el.onclick = function() {
                                    const item = JSON.parse(this.dataset.location);
                                    selectLocationFromSearch(item);
                                };
                            });
                        } else {
                            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥Âú∞ÁÇπ</div>';
                        }
                    })
                    .catch(err => {
                        console.error('ÊêúÁ¥¢Â§±Ë¥•:', err);
                        suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #FF4444;">ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï</div>';
                    });
            } else {
                suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999;">ËØ∑ËæìÂÖ•ÂÖ∑‰ΩìÂú∞ÂùÄÔºåÂ¶Ç"Â§©ÂÆâÈó®"</div>';
            }
        }

        function selectLocationFromSearch(item) {
            selectedLocationData = item;
            document.getElementById('locationInput').value = item.title;
            document.getElementById('locationSuggestions').innerHTML = '';
            console.log('‚úÖ ÈÄâÊã©Âú∞ÁÇπ:', item);
        }

        function enterLocalArea() {
            let center, locationKey;

            if (selectedLocationData && selectedLocationData.location) {
                center = { 
                    lat: selectedLocationData.location.lat, 
                    lng: selectedLocationData.location.lng 
                };
                locationKey = `loc_${selectedLocationData.id}`;
            } else {
                center = myPosition;
                locationKey = 'current_location';
            }

            currentLocalCenter = center;
            currentLocationKey = locationKey;

            if (!localMap) {
                localMap = new qq.maps.Map(document.getElementById('localMap'), {
                    center: new qq.maps.LatLng(center.lat, center.lng),
                    zoom: 15
                });

                // üîß ÂäüËÉΩ9ÔºöÂú®ÈÄâÂÆöÂú∞ÁÇπÊòæÁ§∫ÂÆö‰ΩçÊ†áÂøó
                new qq.maps.Marker({
                    map: localMap,
                    position: new qq.maps.LatLng(center.lat, center.lng),
                    title: selectedLocationData ? selectedLocationData.title : 'ÊàëÁöÑ‰ΩçÁΩÆ'
                });
            } else {
                localMap.setCenter(new qq.maps.LatLng(center.lat, center.lng));
            }

            localBubbles.forEach(item => {
                if (item.marker) item.marker.setMap(null);
                if (item.label) item.label.setMap(null);
            });
            localBubbles = [];

            // ‰ªéÊúçÂä°Âô®Âä†ËΩΩÊ∞îÊ≥°
            allBubbles.forEach(bubble => {
                if (bubble.locationKey === currentLocationKey) {
                    createBubbleOnMap(localMap, localBubbles, bubble, false);
                }
            });

            closeModal('locationModal');
            showScreen('localScreen');
        }

        // ==================== Ê∞îÊ≥°ÁÇπÂáª‰∫ã‰ª∂ ====================
        function onBubbleClick(bubbleData, label) {
            currentBubbleData = bubbleData;
            
            if (bubbleData.type === 'group') {
                // Áæ§ËÅäÊ∞îÊ≥°
                currentGroupData = {
                    id: bubbleData.chatroomId,
                    name: bubbleData.title,
                    online: 0
                };
                
                document.getElementById('groupPreviewName').textContent = bubbleData.title;
                document.getElementById('groupPreviewOnline').textContent = `ÂàõÂª∫ËÄÖ: ${bubbleData.author}`;
                
                document.getElementById('groupPreviewCard').classList.add('active');
            } else {
                // ÊôÆÈÄöÊ∞îÊ≥°
                document.getElementById('previewAvatar').textContent = bubbleData.author ? bubbleData.author[0] : 'üë§';
                document.getElementById('previewNickname').textContent = bubbleData.author || 'ÂåøÂêçÁî®Êà∑';
                document.getElementById('previewTime').textContent = formatTime(bubbleData.createdAt);
                document.getElementById('previewTitle').textContent = bubbleData.title;
                document.getElementById('previewContent').textContent = bubbleData.content || 'ÊöÇÊó†ËØ¶ÁªÜÂÜÖÂÆπ';
                
                document.getElementById('bubblePreviewCard').classList.add('active');
            }

            // ËÆ∞ÂΩïÊµèËßàÂéÜÂè≤
            const existingIndex = userHistory.findIndex(item => item.id === bubbleData.id);
            if (existingIndex > -1) {
                userHistory.splice(existingIndex, 1);
            }
            userHistory.unshift({...bubbleData, viewTime: Date.now()});
            if (userHistory.length > 100) {
                userHistory = userHistory.slice(0, 100);
            }
            saveLocalData();
        }

        function closeBubblePreview() {
            document.getElementById('bubblePreviewCard').classList.remove('active');
        }

        function closeGroupPreview() {
            document.getElementById('groupPreviewCard').classList.remove('active');
        }

        function visitUserProfile() {
            showNetworkStatus('Áî®Êà∑‰∏™‰∫∫‰∏ªÈ°µÂäüËÉΩÂºÄÂèë‰∏≠', 2000);
        }

        function showPostDetail(bubbleData) {
            currentBubbleData = bubbleData;
            
            document.getElementById('detailAvatar').textContent = bubbleData.author ? bubbleData.author[0] : 'üë§';
            document.getElementById('detailNickname').textContent = bubbleData.author || 'ÂåøÂêçÁî®Êà∑';
            document.getElementById('detailTime').textContent = formatTime(bubbleData.createdAt);
            document.getElementById('postDetailTitle').textContent = bubbleData.title;
            document.getElementById('postDetailContent').textContent = bubbleData.content || 'ÊöÇÊó†ËØ¶ÁªÜÂÜÖÂÆπ';

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁÇπËµû/Êî∂Ëóè
            const isLiked = userLikes.some(item => item.id === bubbleData.id);
            const isFavorited = userFavorites.some(item => item.id === bubbleData.id);
            
            document.getElementById('likeBtn').textContent = isLiked ? '‚ù§Ô∏è Â∑≤ÁÇπËµû' : 'üëç ÁÇπËµû';
            document.getElementById('collectBtn').textContent = isFavorited ? '‚≠ê Â∑≤Êî∂Ëóè' : '‚≠ê Êî∂Ëóè';

            // üîß ÂäüËÉΩ4ÔºöÊòæÁ§∫ËØÑËÆ∫Âå∫
            updateCommentsDisplay(bubbleData.comments || []);

            openModal('postDetailModal');
        }

        function joinGroup() {
            if (!currentGroupData) return;
            
            currentChatroomId = currentGroupData.id;
            
            if (USE_SERVER && socket) {
                socket.emit('joinChatroom', {
                    chatroomId: currentChatroomId,
                    userId: currentUser.id,
                    userNickname: currentUser.nickname
                });
            }
            
            document.getElementById('chatroomName').textContent = currentGroupData.name;
            
            closeGroupPreview();
            openModal('chatroomModal');
        }

        function sendChatroomMessage() {
            const input = document.getElementById('chatroomInput');
            const message = input.value.trim();
            
            if (!message || !currentChatroomId) return;
            
            if (USE_SERVER && socket) {
                socket.emit('chatroomMessage', {
                    chatroomId: currentChatroomId,
                    userId: currentUser.id,
                    userNickname: currentUser.nickname,
                    message: message
                });
            } else {
                // Êú¨Âú∞Ê®°Âºè
                const container = document.getElementById('chatroomMessages');
                const div = document.createElement('div');
                div.className = 'chat-message';
                div.innerHTML = `
                    <div class="nickname">${currentUser.nickname}</div>
                    <div class="content">${message}</div>
                `;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            }
            
            input.value = '';
        }

        function leaveChatroom() {
            if (USE_SERVER && socket && currentChatroomId) {
                socket.emit('leaveChatroom', {
                    chatroomId: currentChatroomId,
                    userId: currentUser.id
                });
            }
            
            currentChatroomId = null;
            closeModal('chatroomModal');
        }

        // ==================== ÂèëÂ∏ÉÂäüËÉΩ ====================
        function initPublishTags() {
            // Ê¥ªÂä®Ê†áÁ≠æÔºàÂèØÂ§öÈÄâÔºâ
            document.querySelectorAll('#publishActivityTags .tag').forEach(tag => {
                tag.onclick = function() {
                    this.classList.toggle('selected');
                };
            });

            // Ê∞îÊ≥°Á±ªÂûãÊ†áÁ≠æÔºàÂçïÈÄâÔºâ
            document.querySelectorAll('#publishBubbleTags .tag').forEach(tag => {
                tag.onclick = function() {
                    const parent = this.parentElement;
                    parent.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const type = this.dataset.tag;
                    
                    // Ê†πÊçÆÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑË°®Âçï
                    if (type === 'group') {
                        document.getElementById('normalPublishForm').style.display = 'none';
                        document.getElementById('groupPublishForm').style.display = 'block';
                    } else {
                        document.getElementById('normalPublishForm').style.display = 'block';
                        document.getElementById('groupPublishForm').style.display = 'none';
                    }
                };
            });
        }

        function initPublishLocationSelect() {
            // ÊôÆÈÄöÂèëÂ∏É‰ΩçÁΩÆÈÄâÊã©
            document.getElementById('useCurrentLocationBtn').onclick = function() {
                publishUseCurrentLocation = true;
                publishManualLocation = null;
                
                document.getElementById('useCurrentLocationBtn').classList.add('active');
                document.getElementById('useManualLocationBtn').classList.remove('active');
                document.getElementById('manualLocationInput').style.display = 'none';
                document.getElementById('manualLocationSuggestions').style.display = 'none';
                document.getElementById('selectedLocationDisplay').textContent = 'üìç ÂΩìÂâç‰ΩçÁΩÆ';
            };

            document.getElementById('useManualLocationBtn').onclick = function() {
                publishUseCurrentLocation = false;
                
                document.getElementById('useCurrentLocationBtn').classList.remove('active');
                document.getElementById('useManualLocationBtn').classList.add('active');
                document.getElementById('manualLocationInput').style.display = 'block';
            };

            document.getElementById('manualLocationInput').oninput = function() {
                const input = this.value.trim();
                const suggestionsDiv = document.getElementById('manualLocationSuggestions');
                
                if (!input) {
                    suggestionsDiv.style.display = 'none';
                    suggestionsDiv.innerHTML = '';
                    return;
                }

                suggestionsDiv.style.display = 'block';

                if (USE_SERVER && SERVER_URL) {
                    fetch(`${SERVER_URL}/api/search?keyword=${encodeURIComponent(input)}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 0 && data.data && data.data.length > 0) {
                                const html = data.data.slice(0, 5).map(item => {
                                    return `<div class="suggestion-item" data-location='${JSON.stringify(item)}'>${item.title} - ${item.address || ''}</div>`;
                                }).join('');
                                suggestionsDiv.innerHTML = html;
                                
                                document.querySelectorAll('#manualLocationSuggestions .suggestion-item').forEach(el => {
                                    el.onclick = function() {
                                        const item = JSON.parse(this.dataset.location);
                                        publishManualLocation = item;
                                        document.getElementById('manualLocationInput').value = item.title;
                                        document.getElementById('selectedLocationDisplay').textContent = `üìç ${item.title}`;
                                        suggestionsDiv.style.display = 'none';
                                    };
                                });
                            } else {
                                suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥Âú∞ÁÇπ</div>';
                            }
                        })
                        .catch(err => {
                            console.error('ÊêúÁ¥¢Â§±Ë¥•:', err);
                            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #FF4444;">ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï</div>';
                        });
                } else {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999;">ËØ∑ËæìÂÖ•ÂÖ∑‰ΩìÂú∞ÂùÄ</div>';
                }
            };

            // Áæ§ËÅäÂèëÂ∏É‰ΩçÁΩÆÈÄâÊã©
            document.getElementById('groupUseCurrentLocationBtn').onclick = function() {
                groupPublishUseCurrentLocation = true;
                groupPublishManualLocation = null;
                
                document.getElementById('groupUseCurrentLocationBtn').classList.add('active');
                document.getElementById('groupUseManualLocationBtn').classList.remove('active');
                document.getElementById('groupManualLocationInput').style.display = 'none';
                document.getElementById('groupManualLocationSuggestions').style.display = 'none';
                document.getElementById('groupSelectedLocationDisplay').textContent = 'üìç ÂΩìÂâç‰ΩçÁΩÆ';
            };

            document.getElementById('groupUseManualLocationBtn').onclick = function() {
                groupPublishUseCurrentLocation = false;
                
                document.getElementById('groupUseCurrentLocationBtn').classList.remove('active');
                document.getElementById('groupUseManualLocationBtn').classList.add('active');
                document.getElementById('groupManualLocationInput').style.display = 'block';
            };

            document.getElementById('groupManualLocationInput').oninput = function() {
                const input = this.value.trim();
                const suggestionsDiv = document.getElementById('groupManualLocationSuggestions');
                
                if (!input) {
                    suggestionsDiv.style.display = 'none';
                    suggestionsDiv.innerHTML = '';
                    return;
                }

                suggestionsDiv.style.display = 'block';

                if (USE_SERVER && SERVER_URL) {
                    fetch(`${SERVER_URL}/api/search?keyword=${encodeURIComponent(input)}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 0 && data.data && data.data.length > 0) {
                                const html = data.data.slice(0, 5).map(item => {
                                    return `<div class="suggestion-item" data-location='${JSON.stringify(item)}'>${item.title} - ${item.address || ''}</div>`;
                                }).join('');
                                suggestionsDiv.innerHTML = html;
                                
                                document.querySelectorAll('#groupManualLocationSuggestions .suggestion-item').forEach(el => {
                                    el.onclick = function() {
                                        const item = JSON.parse(this.dataset.location);
                                        groupPublishManualLocation = item;
                                        document.getElementById('groupManualLocationInput').value = item.title;
                                        document.getElementById('groupSelectedLocationDisplay').textContent = `üìç ${item.title}`;
                                        suggestionsDiv.style.display = 'none';
                                    };
                                });
                            } else {
                                suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥Âú∞ÁÇπ</div>';
                            }
                        })
                        .catch(err => {
                            console.error('ÊêúÁ¥¢Â§±Ë¥•:', err);
                            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #FF4444;">ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï</div>';
                        });
                } else {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color: #999;">ËØ∑ËæìÂÖ•ÂÖ∑‰ΩìÂú∞ÂùÄ</div>';
                }
            };
        }

        function publishBubble() {
            // Ê£ÄÊü•Ê∞îÊ≥°Á±ªÂûã
            const selectedTypeTag = document.querySelector('#publishBubbleTags .tag.selected');
            if (!selectedTypeTag) {
                showNetworkStatus('ËØ∑ÈÄâÊã©Ê∞îÊ≥°Á±ªÂûã', 2000);
                return;
            }

            const bubbleType = selectedTypeTag.dataset.tag;

            // Êî∂ÈõÜÊ¥ªÂä®Ê†áÁ≠æ
            const activityTags = Array.from(document.querySelectorAll('#publishActivityTags .tag.selected'))
                .map(tag => tag.dataset.tag);

            let bubbleData;
            let position;

            if (bubbleType === 'group') {
                // Âª∫Áæ§
                const groupName = document.getElementById('groupName').value.trim();
                if (!groupName) {
                    showNetworkStatus('ËØ∑ËæìÂÖ•ËÅäÂ§©ÂÆ§ÂêçÁß∞', 2000);
                    return;
                }

                // Á°ÆÂÆö‰ΩçÁΩÆ
                if (groupPublishUseCurrentLocation) {
                    position = currentLocalCenter || myPosition;
                } else if (groupPublishManualLocation && groupPublishManualLocation.location) {
                    position = {
                        lat: groupPublishManualLocation.location.lat,
                        lng: groupPublishManualLocation.location.lng
                    };
                } else {
                    showNetworkStatus('ËØ∑ÈÄâÊã©ÂèëÂ∏É‰ΩçÁΩÆ', 2000);
                    return;
                }

                bubbleData = {
                    type: 'group',
                    lat: position.lat,
                    lng: position.lng,
                    title: groupName,
                    author: currentUser.nickname,
                    authorId: currentUser.id,
                    duration: 3600,
                    locationKey: currentLocationKey || 'current_location',
                    createdAt: Date.now(),
                    chatroomId: 'chatroom_' + Date.now(),
                    activityTags: activityTags
                };
            } else {
                // ÊôÆÈÄöÊ∞îÊ≥°
                const title = document.getElementById('postTitle').value.trim();
                if (!title) {
                    showNetworkStatus('ËØ∑ËæìÂÖ•Ê†áÈ¢ò', 2000);
                    return;
                }

                const content = document.getElementById('postContent').value.trim();
                const duration = parseInt(document.getElementById('bubbleDuration').value);
                const isPrivate = document.getElementById('privatePost').checked;

                // Á°ÆÂÆö‰ΩçÁΩÆ
                if (publishUseCurrentLocation) {
                    position = currentLocalCenter || myPosition;
                } else if (publishManualLocation && publishManualLocation.location) {
                    position = {
                        lat: publishManualLocation.location.lat,
                        lng: publishManualLocation.location.lng
                    };
                } else {
                    showNetworkStatus('ËØ∑ÈÄâÊã©ÂèëÂ∏É‰ΩçÁΩÆ', 2000);
                    return;
                }

                bubbleData = {
                    type: bubbleType,
                    lat: position.lat,
                    lng: position.lng,
                    title: title,
                    content: content,
                    author: currentUser.nickname,
                    authorId: currentUser.id,
                    duration: duration,
                    isPrivate: isPrivate,
                    locationKey: currentLocationKey || 'current_location',
                    createdAt: Date.now(),
                    activityTags: activityTags,
                    comments: []
                };
            }

            // ÂèëÈÄÅÂà∞ÊúçÂä°Âô®
            if (USE_SERVER && socket) {
                socket.emit('publishBubble', bubbleData);
            } else {
                // Êú¨Âú∞Ê®°Âºè
                bubbleData.id = 'bubble_' + Date.now();
                allBubbles.push(bubbleData);
                createBubbleOnMap(localMap, localBubbles, bubbleData, false);
            }

            userPosts.unshift(bubbleData);
            saveLocalData();

            showNetworkStatus('ÂèëÂ∏ÉÊàêÂäüÔºÅ', 2000);
            closeModal('publishModal');

            // ÈáçÁΩÆË°®Âçï
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('groupName').value = '';
            document.querySelectorAll('#publishActivityTags .tag').forEach(t => t.classList.remove('selected'));
            document.querySelectorAll('#publishBubbleTags .tag').forEach(t => t.classList.remove('selected'));
            document.getElementById('normalPublishForm').style.display = 'none';
            document.getElementById('groupPublishForm').style.display = 'none';
        }

        // ==================== Á≠õÈÄâÂäüËÉΩ ====================
        function initFilterTags() {
            document.querySelectorAll('#filterActivityTags .tag, #filterBubbleTags .tag').forEach(tag => {
                tag.onclick = function() {
                    this.classList.toggle('selected');
                };
            });
        }

        function applyFilter() {
            const activityTags = Array.from(document.querySelectorAll('#filterActivityTags .tag.selected'))
                .map(tag => tag.dataset.tag);
            const bubbleTags = Array.from(document.querySelectorAll('#filterBubbleTags .tag.selected'))
                .map(tag => tag.dataset.tag);

            if (activityTags.length === 0 && bubbleTags.length === 0) {
                showNetworkStatus('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Á≠õÈÄâÊù°‰ª∂', 2000);
                return;
            }

            // Ê∏ÖÁ©∫ÂΩìÂâçÊ∞îÊ≥°
            localBubbles.forEach(item => {
                if (item.marker) item.marker.setMap(null);
                if (item.label) item.label.setMap(null);
            });
            localBubbles = [];

            // Á≠õÈÄâÊ∞îÊ≥°
            allBubbles.forEach(bubble => {
                if (bubble.locationKey !== currentLocationKey) return;

                let match = false;

                // Ê£ÄÊü•Ê∞îÊ≥°Á±ªÂûã
                if (bubbleTags.length > 0 && bubbleTags.includes(bubble.type)) {
                    match = true;
                }

                // Ê£ÄÊü•Ê¥ªÂä®Ê†áÁ≠æ
                if (activityTags.length > 0 && bubble.activityTags) {
                    const hasMatchingTag = bubble.activityTags.some(tag => activityTags.includes(tag));
                    if (hasMatchingTag) match = true;
                }

                if (match) {
                    createBubbleOnMap(localMap, localBubbles, bubble, false);
                }
            });

            closeModal('filterModal');
            showNetworkStatus(`ÊâæÂà∞ ${localBubbles.length} ‰∏™Ê∞îÊ≥°`, 2000);
        }

        function clearFilter() {
            // Ê∏ÖÈô§ÈÄâÊã©
            document.querySelectorAll('#filterActivityTags .tag, #filterBubbleTags .tag').forEach(tag => {
                tag.classList.remove('selected');
            });

            // ÈáçÊñ∞Âä†ËΩΩÊâÄÊúâÊ∞îÊ≥°
            localBubbles.forEach(item => {
                if (item.marker) item.marker.setMap(null);
                if (item.label) item.label.setMap(null);
            });
            localBubbles = [];

            allBubbles.forEach(bubble => {
                if (bubble.locationKey === currentLocationKey) {
                    createBubbleOnMap(localMap, localBubbles, bubble, false);
                }
            });

            closeModal('filterModal');
            showNetworkStatus('Â∑≤Ê∏ÖÈô§Á≠õÈÄâ', 2000);
        }

        // ==================== ‰∏™‰∫∫‰∏≠ÂøÉÂÜÖÂÆπÂä†ËΩΩ ====================
        function loadProfileContent(tab) {
            const contentDiv = document.getElementById('profileContent');

            switch(tab) {
                case 'posts':
                    displayPostList(userPosts, 'ÊàëÂèëÂ∏ÉÁöÑ');
                    break;
                case 'likes':
                    displayPostList(userLikes, 'ÁÇπËµûÁöÑÂ∏ñÂ≠ê');
                    break;
                case 'favorites':
                    displayPostList(userFavorites, 'Êî∂ËóèÁöÑÂ∏ñÂ≠ê');
                    break;
                case 'comments':
                    displayCommentList(userComments);
                    break;
                case 'history':
                    displayPostList(userHistory, 'ÊµèËßàËÆ∞ÂΩï');
                    break;
                case 'search':
                    contentDiv.innerHTML = '<p style="color: #7da0ca; text-align: center; padding: 40px 0;">ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç</p>';
                    break;
            }
        }

        function displayPostList(items, title) {
            const contentDiv = document.getElementById('profileContent');
            
            if (items.length === 0) {
                contentDiv.innerHTML = `<p style="color: #7da0ca; text-align: center; padding: 40px 0;">ÊöÇÊó†${title}</p>`;
                return;
            }

            const html = items.map(item => `
                <div class="post-item" onclick='showPostDetail(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                    <div class="post-item-title">${item.title}</div>
                    <div class="post-item-content">${item.content || 'ÊöÇÊó†ÂÜÖÂÆπ'}</div>
                    <div class="post-item-time">${formatTime(item.createdAt || item.actionTime || item.viewTime)}</div>
                </div>
            `).join('');

            contentDiv.innerHTML = html;
        }

        function displayCommentList(items) {
            const contentDiv = document.getElementById('profileContent');
            
            if (items.length === 0) {
                contentDiv.innerHTML = '<p style="color: #7da0ca; text-align: center; padding: 40px 0;">ÊöÇÊó†ËØÑËÆ∫</p>';
                return;
            }

            const html = items.map(item => `
                <div class="post-item" onclick='showPostDetail(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                    <div class="post-item-title">${item.title}</div>
                    <div class="post-item-content">ÊàëÁöÑËØÑËÆ∫: ${item.comment}</div>
                    <div class="post-item-time">${formatTime(item.actionTime)}</div>
                </div>
            `).join('');

            contentDiv.innerHTML = html;
        }

        // ==================== üîß ÂäüËÉΩ1ÔºöÊî∂‰ª∂ÁÆ±ÂÜÖÂÆπÂä†ËΩΩ ====================
        function loadInboxContent(tab) {
            const listDiv = document.getElementById('inboxList');

            switch(tab) {
                case 'likes':
                    displayNotifications('like', 'favorite');
                    break;
                case 'comments':
                    displayNotifications('comment');
                    break;
                case 'friends':
                    displayFriendsList();
                    break;
                case 'groups':
                    displayGroupsList();
                    break;
                case 'chats':
                    displayChatsList();
                    break;
            }
        }

        function displayNotifications(...types) {
            const listDiv = document.getElementById('inboxList');
            const filteredNotifications = userNotifications.filter(notif => types.includes(notif.type));

            if (filteredNotifications.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 35px 0; font-size: 14px;">ÊöÇÊó†Ê∂àÊÅØ</p>';
                return;
            }

            const typeNames = {
                like: 'ÁÇπËµû‰∫Ü‰Ω†ÁöÑÂ∏ñÂ≠ê',
                favorite: 'Êî∂Ëóè‰∫Ü‰Ω†ÁöÑÂ∏ñÂ≠ê',
                comment: 'ËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂ∏ñÂ≠ê',
                friendRequest: 'Ê∑ªÂä†‰Ω†‰∏∫Â•ΩÂèã',
                groupInvite: 'ÈÇÄËØ∑‰Ω†Âä†ÂÖ•Áæ§ËÅä'
            };

            const html = filteredNotifications.map(notif => `
                <div class="notification-item">
                    <div class="notification-header">
                        <span class="notification-type">${notif.data.fromUser} ${typeNames[notif.type]}</span>
                        <span class="notification-time">${formatTime(notif.time)}</span>
                    </div>
                    <div class="notification-content">
                        ${notif.data.bubbleTitle || notif.data.groupName || ''}
                        ${notif.data.comment ? `<br>ËØÑËÆ∫ÂÜÖÂÆπ: ${notif.data.comment}` : ''}
                    </div>
                </div>
            `).join('');

            listDiv.innerHTML = html;
        }

        function displayFriendsList() {
            const listDiv = document.getElementById('inboxList');

            if (friendsList.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 35px 0; font-size: 14px;">ÊöÇÊó†Â•ΩÂèã</p>';
                return;
            }

            const html = friendsList.map(friend => `
                <div class="friend-item" onclick='openPrivateChat(${JSON.stringify(friend).replace(/'/g, "&apos;")})'>
                    <div class="friend-avatar">${friend.avatar || 'üë§'}</div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.nickname}</div>
                        <div class="friend-status">${statusNames[friend.status] || 'Á¶ªÁ∫ø'}</div>
                    </div>
                </div>
            `).join('');

            listDiv.innerHTML = html;
        }

        function displayGroupsList() {
            const listDiv = document.getElementById('inboxList');

            if (groupsList.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 35px 0; font-size: 14px;">ÊöÇÊó†Áæ§ËÅä</p>';
                return;
            }

            const html = groupsList.map(group => `
                <div class="friend-item" onclick='openGroupChat(${JSON.stringify(group).replace(/'/g, "&apos;")})'>
                    <div class="friend-avatar">üí¨</div>
                    <div class="friend-info">
                        <div class="friend-name">${group.name}</div>
                        <div class="friend-status">${group.memberCount || 0}‰∫∫</div>
                    </div>
                </div>
            `).join('');

            listDiv.innerHTML = html;
        }

        function displayChatsList() {
            const listDiv = document.getElementById('inboxList');
            listDiv.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 35px 0; font-size: 14px;">ÊúÄËøëËÅäÂ§©ÂäüËÉΩÂºÄÂèë‰∏≠</p>';
        }

        // ==================== üîß ÂäüËÉΩ2ÔºöÊêúÁ¥¢Â•ΩÂèã ====================
        function searchFriend() {
            const query = document.getElementById('searchFriendInput').value.trim();
            const resultsDiv = document.getElementById('searchFriendResults');

            if (!query) {
                resultsDiv.innerHTML = '';
                return;
            }

            if (USE_SERVER && SERVER_URL) {
                fetch(`${SERVER_URL}/api/users/search?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 0 && data.data && data.data.length > 0) {
                            const html = data.data.map(user => `
                                <div class="friend-item" onclick='addFriend("${user.userId}", "${user.nickname}")'>
                                    <div class="friend-avatar">${user.avatar || 'üë§'}</div>
                                    <div class="friend-info">
                                        <div class="friend-name">${user.nickname}</div>
                                        <div class="friend-status">ID: ${user.userId}</div>
                                    </div>
                                    <button style="padding: 5px 15px; background: #5483B3; color: white; border: none; border-radius: 5px;">Ê∑ªÂä†</button>
                                </div>
                            `).join('');
                            resultsDiv.innerHTML = html;
                        } else {
                            resultsDiv.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 20px;">Êú™ÊâæÂà∞Áî®Êà∑</p>';
                        }
                    })
                    .catch(err => {
                        console.error('ÊêúÁ¥¢Â§±Ë¥•:', err);
                        resultsDiv.innerHTML = '<p style="text-align: center; color: #FF4444; padding: 20px;">ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï</p>';
                    });
            } else {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ËØ∑ÂêØÁî®ÊúçÂä°Âô®Ê®°Âºè</p>';
            }
        }

        function addFriend(userId, nickname) {
            if (USE_SERVER && socket) {
                socket.emit('addFriend', {
                    fromUserId: currentUser.id,
                    toUserId: userId,
                    fromUserNickname: currentUser.nickname
                });
                showNetworkStatus(`Â∑≤Ê∑ªÂä† ${nickname} ‰∏∫Â•ΩÂèã`, 2000);
                closeModal('addFriendModal');
            } else {
                showNetworkStatus('ËØ∑ÂêØÁî®ÊúçÂä°Âô®Ê®°Âºè', 2000);
            }
        }

        // ==================== üîß ÂäüËÉΩ3ÔºöÂèëËµ∑Áæ§ËÅä ====================
        function loadFriendSelector() {
            const listDiv = document.getElementById('friendSelectorList');

            if (friendsList.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #7da0ca; padding: 20px;">ÊöÇÊó†Â•ΩÂèã</p>';
                return;
            }

            const html = friendsList.map(friend => `
                <div class="friend-selector-item">
                    <input type="checkbox" id="friend_${friend.userId}" value="${friend.userId}">
                    <label for="friend_${friend.userId}">${friend.nickname}</label>
                </div>
            `).join('');

            listDiv.innerHTML = html;
        }

        function confirmCreateGroup() {
            const groupName = document.getElementById('groupChatName').value.trim();
            const selectedFriends = Array.from(document.querySelectorAll('#friendSelectorList input:checked'))
                .map(checkbox => checkbox.value);

            if (selectedFriends.length === 0) {
                showNetworkStatus('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰ΩçÂ•ΩÂèã', 2000);
                return;
            }

            if (USE_SERVER && socket) {
                socket.emit('createGroupChat', {
                    groupName: groupName || 'Êú™ÂëΩÂêçÁæ§ËÅä',
                    members: selectedFriends,
                    creatorId: currentUser.id,
                    creatorNickname: currentUser.nickname
                });
                showNetworkStatus('Áæ§ËÅäÂàõÂª∫ÊàêÂäü', 2000);
                closeModal('createGroupModal');
            } else {
                showNetworkStatus('ËØ∑ÂêØÁî®ÊúçÂä°Âô®Ê®°Âºè', 2000);
            }
        }

        // ==================== Âä†ËΩΩÂ•ΩÂèãÂíåÁæ§ËÅäÂàóË°® ====================
        function loadFriendsList() {
            if (USE_SERVER && socket) {
                socket.emit('getFriendsList', { userId: currentUser.id });
            }
        }

        function loadGroupsList() {
            if (USE_SERVER && socket) {
                socket.emit('getGroupChats', { userId: currentUser.id });
            }
        }

        // ==================== ËÆæÁΩÆÂäüËÉΩ ====================
        function changeAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentUser.avatarImg = event.target.result;
                        updateProfileDisplay();
                        saveLocalData();
                        showNetworkStatus('Â§¥ÂÉèÂ∑≤Êõ¥Êç¢', 2000);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function changeNickname() {
            const newNickname = prompt('ËØ∑ËæìÂÖ•Êñ∞ÊòµÁß∞Ôºö', currentUser.nickname);
            if (newNickname && newNickname.trim()) {
                currentUser.nickname = newNickname.trim();
                updateProfileDisplay();
                saveLocalData();
                showNetworkStatus('ÊòµÁß∞Â∑≤‰øÆÊîπ', 2000);
            }
        }

        function changeBackground() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentUser.backgroundImg = event.target.result;
                        updateProfileDisplay();
                        saveLocalData();
                        showNetworkStatus('ËÉåÊôØÂõæÂ∑≤Êõ¥Êç¢', 2000);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function changeBio() {
            showNetworkStatus('‰∏™‰∫∫ÁÆÄ‰ªãÂäüËÉΩÂºÄÂèë‰∏≠', 2000);
        }

        function changeGender() {
            showNetworkStatus('ÊÄßÂà´ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠', 2000);
        }

        function changeBirthday() {
            showNetworkStatus('ÁîüÊó•ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠', 2000);
        }

        function changeRegion() {
            showNetworkStatus('Âú∞Âå∫ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠', 2000);
        }

        function realNameAuth() {
            showNetworkStatus('ÂÆûÂêçËÆ§ËØÅÂäüËÉΩÂºÄÂèë‰∏≠', 2000);
        }

        function merchantAuth() {
            showNetworkStatus('ÂïÜÂÆ∂ËÆ§ËØÅÂäüËÉΩÂºÄÂèë‰∏≠', 2000);
        }

    </script>
</body>
</html>
